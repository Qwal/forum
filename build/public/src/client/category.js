"use strict";define("forum/category",["forum/infinitescroll","share","navigator","forum/category/tools","forum/recent","sort","components","translator","topicSelect","forum/pagination","storage"],function(g,t,n,o,e,i,s,a,l,c,r){var d={};$(window).on("action:ajaxify.start",function(t,o){if(!String(o.url).startsWith("category/")){n.disable();p()}});function p(){o.removeListeners();e.removeListeners()}d.init=function(){var a=ajaxify.data.cid;app.enterRoom("category_"+a);t.addShareHandlers(ajaxify.data.name);o.init(a);e.watchForNewPosts();i.handleSort("categoryTopicSort","user.setCategorySort","category/"+ajaxify.data.slug);u();$('[component="category"]').on("click",'[component="topic/header"]',function(){var e=$(this).parents("[data-index]").attr("data-index");$('[component="category/topic"]').each(function(t,o){if($(o).offset().top-$(window).scrollTop()>0){r.setItem("category:"+a+":bookmark",$(o).attr("data-index"));r.setItem("category:"+a+":bookmark:clicked",e);return false}})});f();m(a);$(window).trigger("action:topics.loaded",{topics:ajaxify.data.topics});$(window).trigger("action:category.loaded",{cid:ajaxify.data.cid})};function f(){var t=window.location.pathname.split("/");var o=t[t.length-1];if(o&&utils.isNumber(o)){o=Math.max(0,parseInt(o,10)-1);if(o&&window.location.search.indexOf("page=")===-1){n.scrollToElement($('[component="category/topic"][data-index="'+o+'"]'),true,0)}}}function m(e){$('[component="category/watching"], [component="category/ignoring"]').on("click",function(){var t=$(this);var o=t.attr("component")==="category/watching"?"watch":"ignore";socket.emit("categories."+o,e,function(t){if(t){return app.alertError(t.message)}$('[component="category/watching/menu"]').toggleClass("hidden",o!=="watch");$('[component="category/watching/check"]').toggleClass("fa-check",o==="watch");$('[component="category/ignoring/menu"]').toggleClass("hidden",o!=="ignore");$('[component="category/ignoring/check"]').toggleClass("fa-check",o==="ignore");app.alertSuccess("[[category:"+o+".message]]")})})}d.toTop=function(){n.scrollTop(0)};d.toBottom=function(){socket.emit("categories.getTopicCount",ajaxify.data.cid,function(t,o){if(t){return app.alertError(t.message)}n.scrollBottom(o-1)})};d.navigatorCallback=function(t,o){return o};$(window).on("action:popstate",function(){if(ajaxify.data.template.category&&ajaxify.data.cid){var t=r.getItem("category:"+ajaxify.data.cid+":bookmark");var o=r.getItem("category:"+ajaxify.data.cid+":bookmark:clicked");r.removeItem("category:"+ajaxify.data.cid+":bookmark");r.removeItem("category:"+ajaxify.data.cid+":bookmark:clicked");t=Math.max(0,parseInt(t,10)||0);o=Math.max(0,parseInt(o,10)||0);if(!parseInt(t,10)){return}if(config.usePagination){var e=Math.ceil((parseInt(t,10)+1)/config.topicsPerPage);if(parseInt(e,10)!==ajaxify.data.pagination.currentPage){c.loadPage(e,function(){d.scrollToTopic(t,o,0)})}else{d.scrollToTopic(t,o,0)}}else{if(t===0){d.highlightTopic(o);return}$('[component="category"]').empty();h(Math.max(0,t-1)+1,1,function(){$(window).one("action:topics.loaded",function(){d.scrollToTopic(t,o,0)})})}}});d.highlightTopic=function(t){var o=s.get("category/topic","index",t);if(o.length&&!o.hasClass("highlight")){o.addClass("highlight");setTimeout(function(){o.removeClass("highlight")},5e3)}};d.scrollToTopic=function(t,o,e,a){if(!t){return}if(!a){a=0}var i=s.get("category/topic","index",t);if(i.length){$("html, body").animate({scrollTop:i.offset().top-a+"px"},e!==undefined?e:400,function(){d.highlightTopic(o);n.update()})}};function u(){if(!config.usePagination){n.init('[component="category/topic"]',ajaxify.data.topic_count,d.toTop,d.toBottom,d.navigatorCallback);g.init($('[component="category"]'),d.loadMoreTopics)}else{n.disable()}}d.loadMoreTopics=function(t){if(!$('[component="category"]').length||!$('[component="category"]').children().length){return}var o=$('[component="category/topic"]');var e=t>0?o.last():o.first();var a=(parseInt(e.attr("data-index"),10)||0)+(t>0?1:0);h(a,t)};function h(t,e,a){a=a||function(){};if(!utils.isNumber(t)||t===0&&s.get("category/topic","index",0).length){return a()}$(window).trigger("action:category.loading");var o=utils.params();g.loadMore("categories.loadMore",{cid:ajaxify.data.cid,after:t,direction:e,query:o,categoryTopicSort:config.categoryTopicSort},function(t,o){if(t.topics&&t.topics.length){d.onTopicsLoaded(t,e,o)}else{o()}$(window).trigger("action:category.loaded");a()})}d.onTopicsLoaded=function(a,i,n){if(!a||!a.topics.length){return n()}function t(t){return t.filter(function(t){return s.get("category/topic","tid",t.tid).length===0})}a.topics=t(a.topics);if(!a.topics.length){return n()}a.showSelect=a.privileges.editable;var c;var r;var o=$('[component="category/topic"]');if(i>0&&o.length){c=o.last()}else if(i<0&&o.length){r=o.first()}app.parseAndTranslate("category","topics",a,function(t){$('[component="category"]').removeClass("hidden");$(".category-sidebar").removeClass("hidden");$("#category-no-topics").remove();if(c){t.insertAfter(c)}else if(r){var o=$(document).height();var e=$(window).scrollTop();t.insertBefore(r);$(window).scrollTop(e+($(document).height()-o))}else{$('[component="category"]').append(t)}if(!l.getSelectedTids().length){g.removeExtra($('[component="category/topic"]'),i,config.topicsPerPage*3)}t.find(".timeago").timeago();app.createUserTooltips();utils.makeNumbersHumanReadable(t.find(".human-readable-number"));$(window).trigger("action:topics.loaded",{topics:a.topics});n()})};return d});
//# sourceMappingURL=public/src/client/category.js.map