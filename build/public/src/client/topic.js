"use strict";define("forum/topic",["forum/infinitescroll","forum/topic/threadTools","forum/topic/postTools","forum/topic/events","forum/topic/posts","forum/topic/images","forum/topic/replies","navigator","sort","components","storage"],function(o,a,i,e,n,r,c,s,p,l,f){var u={};var d="";$(window).on("action:ajaxify.start",function(t,o){if(u.replaceURLTimeout){clearTimeout(u.replaceURLTimeout);u.replaceURLTimeout=0}if(!String(o.url).startsWith("topic/")){s.disable();l.get("navbar/title").find("span").text("").hide();app.removeAlert("bookmark");e.removeListeners();require(["search"],function(t){if(t.topicDOM.active){t.topicDOM.end()}})}});u.init=function(){var t=ajaxify.data.tid;$(window).trigger("action:topic.loading");app.enterRoom("topic_"+t);n.processPage(l.get("post"));i.init(t);a.init(t);c.init(t);e.init();p.handleSort("topicPostSort","user.setTopicSort","topic/"+ajaxify.data.slug);if(!config.usePagination){o.init($('[component="topic"]'),n.loadMorePosts)}k();v();s.init('[component="post"]',ajaxify.data.postcount,u.toTop,u.toBottom,u.navigatorCallback,u.calculateIndex);g(t);$(window).on("scroll",h);m();$(window).trigger("action:topic.loaded",ajaxify.data)};function m(){require(["search","mousetrap"],function(t,o){$(".topic-search").off("click").on("click",".prev",function(){t.topicDOM.prev()}).on("click",".next",function(){t.topicDOM.next()});o.bind("ctrl+f",function(t){if(config.topicSearchEnabled){var o=ajaxify.currentPage.match(/^topic\/([\d]+)/);var a;if(o){t.preventDefault();a=o[1];$("#search-fields input").val("in:topic-"+a+" ");app.prepareSearch()}}})})}u.toTop=function(){s.scrollTop(0)};u.toBottom=function(){socket.emit("topics.postcount",ajaxify.data.tid,function(t,o){if(t){return app.alertError(t.message)}if(config.topicPostSort!=="oldest_to_newest"){o=2}s.scrollBottom(o-1)})};function g(t){var o=ajaxify.data.bookmark||f.getItem("topic:"+t+":bookmark");var a=ajaxify.data.postIndex;if(a>0){if(l.get("post/anchor",a-1).length){return s.scrollToPostIndex(a-1,true,0)}}else if(o&&(!config.usePagination||config.usePagination&&ajaxify.data.pagination.currentPage===1)&&ajaxify.data.postcount>ajaxify.data.bookmarkThreshold){app.alert({alert_id:"bookmark",message:"[[topic:bookmark_instructions]]",timeout:0,type:"info",clickfn:function(){s.scrollToIndex(parseInt(o-1,10),true)},closefn:function(){f.removeItem("topic:"+t+":bookmark")}});setTimeout(function(){app.removeAlert("bookmark")},1e4)}}function k(){l.get("topic").on("click","blockquote .toggle",function(){var t=$(this).parent("blockquote");var o=$(this);t.toggleClass("uncollapsed");var a=!t.hasClass("uncollapsed");o.toggleClass("fa-angle-down",a).toggleClass("fa-angle-up",!a)})}function v(){l.get("topic").on("click",'[component="post/parent"]',function(t){var o=$(this).attr("data-topid");var a=$('[component="topic"]>[component="post"][data-pid="'+o+'"]');if(a.length){t.preventDefault();s.scrollToIndex(a.attr("data-index"),true);return false}})}function h(){var t=l.get("navbar/title").find("span");if($(window).scrollTop()>50&&t.hasClass("hidden")){t.html(ajaxify.data.title).removeClass("hidden")}else if($(window).scrollTop()<=50&&!t.hasClass("hidden")){t.html("").addClass("hidden")}if($(window).scrollTop()>300){app.removeAlert("bookmark")}}u.calculateIndex=function(t,o){if(t!==1&&config.topicPostSort!=="oldest_to_newest"){return o-t+2}return t};u.navigatorCallback=function(o,a,t){var i=ajaxify.removeRelativePath(window.location.pathname.slice(1));if(!i.startsWith("topic")){return}if(s.scrollActive){return}r.loadImages(t);var e="topic/"+ajaxify.data.slug+(o>1?"/"+o:"");if(e!==d){if(u.replaceURLTimeout){clearTimeout(u.replaceURLTimeout)}u.replaceURLTimeout=setTimeout(function(){if(o>=a&&app.user.uid){socket.emit("topics.markAsRead",[ajaxify.data.tid])}x(o);u.replaceURLTimeout=0;if(history.replaceState){var t=window.location.search||"";if(!config.usePagination){t=t&&!/^\?page=\d+$/.test(t)?t:""}history.replaceState({url:e+t},null,window.location.protocol+"//"+window.location.host+RELATIVE_PATH+"/"+e+t)}d=e},500)}};function x(o){var t="topic:"+ajaxify.data.tid+":bookmark";var a=ajaxify.data.bookmark||f.getItem(t);if(ajaxify.data.postcount>ajaxify.data.bookmarkThreshold&&(!a||parseInt(o,10)>parseInt(a,10)||ajaxify.data.postcount<parseInt(a,10))){if(app.user.uid){socket.emit("topics.bookmark",{tid:ajaxify.data.tid,index:o},function(t){if(t){return app.alertError(t.message)}ajaxify.data.bookmark=o})}else{f.setItem(t,o)}}if(!a||parseInt(o,10)>=parseInt(a,10)){app.removeAlert("bookmark")}}return u});
//# sourceMappingURL=public/src/client/topic.js.map