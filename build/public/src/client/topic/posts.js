"use strict";define("forum/topic/posts",["forum/pagination","forum/infinitescroll","forum/topic/postTools","forum/topic/images","navigator","components"],function(s,p,e,n,r,d){var l={};l.onNewPost=function(o){if(!o||!o.posts||!o.posts.length||parseInt(o.posts[0].tid,10)!==parseInt(ajaxify.data.tid,10)){return}o.loggedIn=!!app.user.uid;o.privileges=ajaxify.data.privileges;o.posts[0].timestamp=Date.now()-1e3;o.posts[0].timestampISO=utils.toISOString(o.posts[0].timestamp);l.modifyPostsByPrivileges(o.posts);t(o.posts);ajaxify.data.postcount+=1;e.updatePostCount(ajaxify.data.postcount);if(config.usePagination){a(o)}else{i(o)}require(["forum/topic/replies"],function(t){t.onNewPost(o)})};l.modifyPostsByPrivileges=function(t){t.forEach(function(t){t.selfPost=!!app.user.uid&&parseInt(t.uid,10)===parseInt(app.user.uid,10);t.display_edit_tools=ajaxify.data.privileges["posts:edit"]&&t.selfPost||ajaxify.data.privileges.isAdminOrMod;t.display_delete_tools=ajaxify.data.privileges["posts:delete"]&&t.selfPost||ajaxify.data.privileges.isAdminOrMod;t.display_moderator_tools=t.display_edit_tools||t.display_delete_tools;t.display_move_tools=ajaxify.data.privileges.isAdminOrMod;t.display_post_menu=ajaxify.data.privileges.isAdminOrMod||t.selfPost&&!ajaxify.data.locked||(app.user.uid||ajaxify.data.postSharing.length)&&!t.deleted})};function t(t){for(var o=0;o<t.length;o+=1){var e=d.get("user/postcount",t[o].uid);e.html(parseInt(e.attr("data-postcount"),10)+1);utils.addCommasToNumbers(e)}}function a(t){function o(){c(t.posts[0]);n.loadImages()}var e=t.posts;ajaxify.data.pagination.pageCount=Math.max(1,Math.ceil(e[0].topic.postcount/config.postsPerPage));var a=config.topicPostSort==="oldest_to_newest"||config.topicPostSort==="most_votes"?1:-1;var i=ajaxify.data.pagination.currentPage===ajaxify.data.pagination.pageCount&&a===1||ajaxify.data.pagination.currentPage===1&&a===-1;if(i){g(t,d.get("post").not("[data-index=0]"),a,o)}else if(ajaxify.data.scrollToMyPost&&parseInt(e[0].uid,10)===parseInt(app.user.uid,10)){setTimeout(function(){s.loadPage(ajaxify.data.pagination.pageCount,o)},250)}else{f()}}function f(){$.get(config.relative_path+"/api/topic/pagination/"+ajaxify.data.tid,{page:ajaxify.data.pagination.currentPage},function(t){app.parseAndTranslate("partials/paginator",{pagination:t},function(t){$('[component="pagination"]').after(t).remove()})})}function i(o){var t=config.topicPostSort==="oldest_to_newest"||config.topicPostSort==="most_votes"?1:-1;var e=$('[component="post"][data-index="'+(o.posts[0].index-1)+'"]').length;if(!e&&(!o.posts[0].selfPost||!ajaxify.data.scrollToMyPost)){return}if(!e&&o.posts[0].selfPost){return ajaxify.go("post/"+o.posts[0].pid)}g(o,d.get("post").not("[data-index=0]"),t,function(t){if(t){t.addClass("new")}c(o.posts[0]);n.loadImages()})}function c(t){if(t.selfPost&&ajaxify.data.scrollToMyPost){r.scrollBottom(t.index)}}function g(a,t,i,s){s=s||function(){};if(!a||a.posts&&!a.posts.length){return s()}function o(){var t=$('[component="post"].new');if(t.length===a.posts.length){var e=true;t.each(function(t,o){if(parseInt($(o).attr("data-pid"),10)!==parseInt(a.posts[t].pid,10)){e=false}});if(e){t.each(function(){$(this).removeClass("new")});a.posts.length=0;return}}if(t.length&&a.posts.length>1){a.posts.forEach(function(t){var o=d.get("post","pid",t.pid);if(o.hasClass("new")){o.remove()}})}a.posts=a.posts.filter(function(t){return $('[component="post"][data-pid="'+t.pid+'"]').length===0})}o();if(!a.posts.length){return s()}var n;var r;if(i>0&&t.length){n=t.last()}else if(i<0&&t.length){r=t.first()}a.slug=ajaxify.data.slug;$(window).trigger("action:posts.loading",{posts:a.posts,after:n,before:r});app.parseAndTranslate("topic","posts",a,function(t){t=t.filter(function(){var t=$(this).attr("data-pid");return t&&$('[component="post"][data-pid="'+t+'"]').length===0});if(n){t.insertAfter(n)}else if(r){var o=$(document).height();var e=$(window).scrollTop();t.insertBefore(r);$(window).scrollTop(e+($(document).height()-o))}else{d.get("topic").append(t)}p.removeExtra($('[component="post"]'),i,config.postsPerPage*2);$(window).trigger("action:posts.loaded",{posts:a.posts});l.processPage(t);s(t)})}l.loadMorePosts=function(e){if(!d.get("topic").length||r.scrollActive||l._infiniteScrollTimeout){return}l._infiniteScrollTimeout=setTimeout(function(){delete l._infiniteScrollTimeout},1e3);var a=d.get("topic").find(d.get("post").not("[data-index=0]").not(".new"));var t=e>0?a.last():a.first();var o=parseInt(t.attr("data-index"),10)||0;var i=ajaxify.data.tid;if(!utils.isNumber(i)||!utils.isNumber(o)||e<0&&d.get("post","index",0).length){return}var s=$(".loading-indicator");if(!s.is(":animated")){s.fadeIn()}p.loadMore("topics.loadMore",{tid:i,after:o,count:config.postsPerPage,direction:e,topicPostSort:config.topicPostSort},function(t,o){s.fadeOut();if(t&&t.posts&&t.posts.length){g(t,a,e,o)}else{r.update();o()}})};l.processPage=function(t){n.unloadImages(t);l.showBottomPostBar();t.find('[component="post/content"] img:not(.not-responsive)').addClass("img-responsive");app.createUserTooltips(t);app.replaceSelfLinks(t.find("a"));utils.addCommasToNumbers(t.find(".formatted-number"));utils.makeNumbersHumanReadable(t.find(".human-readable-number"));t.find(".timeago").timeago();u(t.find('[component="post/content"] > blockquote > blockquote'));o(t)};l.showBottomPostBar=function(){var t=d.get("post","index",0);var o=$(".post-bar-placeholder");var e=$('[component="post"]');if(!!t.length&&e.length>1&&$(".post-bar").length<2&&o.length){$(".post-bar").clone().insertAfter(o);o.remove()}else if(t.length&&e.length<2){t.find(".post-bar").remove()}};function o(t){t.each(function(){if($(this).hasClass("deleted")){e.toggle($(this).attr("data-pid"),true)}})}function u(t){t.each(function(){var t=$(this);if(t.find(":hidden:not(br)").length&&!t.find(".toggle").length){t.append('<i class="fa fa-angle-down pointer toggle"></i>')}})}return l});
//# sourceMappingURL=public/src/client/topic/posts.js.map