"use strict";define("forum/topic/postTools",["share","navigator","components","translator","forum/topic/votes","forum/topic/move-post","forum/topic/diffs"],function(o,a,i,r,s,p,c){var e={};var n=false;e.init=function(t){n=false;d();l(t);o.addShareHandlers(ajaxify.data.titleRaw);s.addVoteHandler();e.updatePostCount(ajaxify.data.postcount)};function d(){$('[component="topic"]').on("show.bs.dropdown",".moderator-tools",function(){var t=$(this);var a=t.find(".dropdown-menu");if(a.html()){return}var o=t.parents("[data-pid]");var e=o.attr("data-pid");var n=parseInt(o.attr("data-index"),10);socket.emit("posts.loadPostTools",{pid:e,cid:ajaxify.data.cid},function(t,o){if(t){return app.alertError(t.message)}o.posts.display_move_tools=o.posts.display_move_tools&&n!==0;app.parseAndTranslate("partials/topic/post-menu-list",o,function(t){a.html(t);require(["clipboard"],function(t){new t("[data-clipboard-text]")});$(window).trigger("action:post.tools.load")})})})}e.toggle=function(t,o){var a=i.get("post","pid",t);a.find('[component="post/quote"], [component="post/bookmark"], [component="post/reply"], [component="post/flag"], [component="user/chat"]').toggleClass("hidden",o);a.find('[component="post/delete"]').toggleClass("hidden",o);a.find('[component="post/restore"]').toggleClass("hidden",!o);a.find('[component="post/purge"]').toggleClass("hidden",!o);a.find('[component="post/tools"] .dropdown-menu').html("")};e.updatePostCount=function(t){var o=i.get("topic/post-count");o.html(t).attr("title",t);utils.makeNumbersHumanReadable(o);a.setCount(t)};function l(e){var t=i.get("topic");t.on("click",'[component="post/quote"]',function(){f($(this),e)});t.on("click",'[component="post/reply"]',function(){u($(this),e)});$(".topic").on("click",'[component="topic/reply"]',function(t){t.preventDefault();u($(this),e)});$(".topic").on("click",'[component="topic/reply-as-topic"]',function(){r.translate("[[topic:link_back, "+ajaxify.data.titleRaw+", "+config.relative_path+"/topic/"+ajaxify.data.slug+"]]",function(t){$(window).trigger("action:composer.topic.new",{cid:ajaxify.data.cid,body:t})})});t.on("click",'[component="post/bookmark"]',function(){return g($(this),v($(this),"data-pid"))});t.on("click",'[component="post/upvote"]',function(){return s.toggleVote($(this),".upvoted","posts.upvote")});t.on("click",'[component="post/downvote"]',function(){return s.toggleVote($(this),".downvoted","posts.downvote")});t.on("click",'[component="post/vote-count"]',function(){s.showVotes(v($(this),"data-pid"))});t.on("click",'[component="post/flag"]',function(){var o=v($(this),"data-pid");require(["flags"],function(t){t.showFlagModal({type:"post",id:o})})});t.on("click",'[component="post/edit"]',function(){var t=$(this);var o=parseInt(v(t,"data-timestamp"),10);var a=parseInt(ajaxify.data.postEditDuration,10);if(n(a,o,"post-edit-duration-expired")){$(window).trigger("action:composer.post.edit",{pid:v(t,"data-pid")})}});t.on("click",'[component="post/view-history"], [component="post/edit-indicator"]',function(){var t=$(this);c.open(v(t,"data-pid"))});t.on("click",'[component="post/delete"]',function(){var t=$(this);var o=parseInt(v(t,"data-timestamp"),10);var a=parseInt(ajaxify.data.postDeleteDuration,10);if(n(a,o,"post-delete-duration-expired")){w($(this),e)}});function n(t,o,a){if(!ajaxify.data.privileges.isAdminOrMod&&t&&Date.now()-o>t*1e3){var e=Math.floor(t/86400);var n=Math.floor(t%86400/3600);var i=Math.floor(t%86400%3600/60);var r=t%86400%3600%60;var s="[[error:"+a+", "+t+"]]";if(e){if(n){s="[[error:"+a+"-days-hours, "+e+", "+n+"]]"}else{s="[[error:"+a+"-days, "+e+"]]"}}else if(n){if(i){s="[[error:"+a+"-hours-minutes, "+n+", "+i+"]]"}else{s="[[error:"+a+"-hours, "+n+"]]"}}else if(i){if(r){s="[[error:"+a+"-minutes-seconds, "+i+", "+r+"]]"}else{s="[[error:"+a+"-minutes, "+i+"]]"}}app.alertError(s);return false}return true}t.on("click",'[component="post/restore"]',function(){w($(this),e)});t.on("click",'[component="post/purge"]',function(){k($(this),e)});t.on("click",'[component="post/move"]',function(){p.openMovePostModal($(this))});t.on("click",'[component="post/ban-ip"]',function(){var t=$(this).attr("data-ip");socket.emit("blacklist.addRule",t,function(t){if(t){return app.alertError(t.message)}app.alertSuccess("[[admin/manage/blacklist:ban-ip]]")})});t.on("click",'[component="post/chat"]',function(){x($(this))})}function u(a,e){var n=m();b(function(){var t=h(a);if(v(a,"data-uid")==="0"||!v(a,"data-userslug")){t=""}var o=a.is('[component="post/reply"]')?v(a,"data-pid"):null;if(n.text&&(!o||!n.pid||o===n.pid)){t=t||n.username;$(window).trigger("action:composer.addQuote",{tid:e,pid:o,topicName:ajaxify.data.titleRaw,username:t,text:n.text,selectedPid:n.pid})}else{$(window).trigger("action:composer.post.new",{tid:e,pid:o,topicName:ajaxify.data.titleRaw,text:t?t+" ":""})}})}function f(t,n){var i=m();b(function(){var o=h(t);var a=v(t,"data-pid");function e(t){$(window).trigger("action:composer.addQuote",{tid:n,pid:a,username:o,topicName:ajaxify.data.titleRaw,text:t})}if(i.text&&a&&a===i.pid){return e(i.text)}socket.emit("posts.getRawPost",a,function(t,o){if(t){return app.alertError(t.message)}e(o)})})}function m(){var t="";var o;var a="";var e=window.getSelection?window.getSelection():document.selection.createRange();var n=$('[component="post"] [component="post/content"]');var i;n.each(function(t,o){if(e&&e.containsNode&&o&&e.containsNode(o,true)){i=o}});if(i){var r=document.createRange();r.selectNodeContents(i);var s=e.getRangeAt(0).cloneRange();if(s.compareBoundaryPoints(Range.START_TO_START,r)<0){s.setStart(r.startContainer,r.startOffset)}if(s.compareBoundaryPoints(Range.END_TO_END,r)>0){s.setEnd(r.endContainer,r.endOffset)}r.detach();t=s.toString();var p=$(i).parents('[component="post"]');o=p.attr("data-pid");a=h($(i));s.detach()}return{text:t,pid:o,username:a}}function g(t,o){var a=t.attr("data-bookmarked")==="false"?"posts.bookmark":"posts.unbookmark";socket.emit(a,{pid:o,room_id:"topic_"+ajaxify.data.tid},function(t){if(t){app.alertError(t.message)}});return false}function v(t,o){return t.parents("[data-pid]").attr(o)}function h(t){var o="";var a=t.parents("[data-pid]");if(t.attr("component")==="topic/reply"){return o}if(a.length){o=a.attr("data-userslug")}if(a.length&&a.attr("data-uid")!=="0"){o="@"+o}return o}function w(t,o){var a=v(t,"data-pid");var e=i.get("post","pid",a);var n=!e.hasClass("deleted")?"delete":"restore";y(n,a,o)}function k(t,o){y("purge",v(t,"data-pid"),o)}function y(o,a,e){r.translate("[[topic:post_"+o+"_confirm]]",function(t){bootbox.confirm(t,function(t){if(!t){return}socket.emit("posts."+o,{pid:a,tid:e},function(t){if(t){app.alertError(t.message)}})})})}function x(t){var o=t.parents("[data-pid]");app.newChat(o.attr("data-uid"));t.parents(".btn-group").find(".dropdown-toggle").click();return false}function b(a){var t=Math.min(Date.now()-1e3*60*60*24*ajaxify.data.topicStaleDays,864e13);if(n||ajaxify.data.lastposttime>=t){return a()}r.translate("[[topic:stale.warning]]",function(t){var o=bootbox.dialog({title:"[[topic:stale.title]]",message:t,buttons:{reply:{label:"[[topic:stale.reply_anyway]]",className:"btn-link",callback:function(){n=true;a()}},create:{label:"[[topic:stale.create]]",className:"btn-primary",callback:function(){r.translate("[[topic:link_back, "+ajaxify.data.title+", "+config.relative_path+"/topic/"+ajaxify.data.slug+"]]",function(t){$(window).trigger("action:composer.topic.new",{cid:ajaxify.data.cid,body:t})})}}}});o.modal()})}return e});
//# sourceMappingURL=public/src/client/topic/postTools.js.map