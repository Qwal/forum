{"version":3,"sources":["public/src/client/recent.js"],"names":["define","infinitescroll","components","Recent","newTopicCount","newPostCount","$","window","on","ev","data","ajaxify","currentPage","url","removeListeners","init","app","enterRoom","watchForNewPosts","handleCategorySelection","this","addClass","config","usePagination","loadMoreTopics","trigger","topics","socket","onNewTopic","onNewPost","selectedCids","indexOf","parseInt","cid","selectedFilter","filter","template","category","updateAlertText","showAlert","post","posts","topic","mainPid","pid","emit","tid","err","isFollowed","alertError","message","getSelectedCids","cids","each","index","el","find","length","push","attr","sort","a","b","changed","forEach","decodeURIComponent","param","go","selectChildren","parentCid","flag","toggleClass","categoryEl","ctrlKey","hasClass","first","removeListener","text","translateText","removeClass","fadeIn","direction","loadMore","after","count","topicsPerPage","utils","params","set","done","onTopicsLoaded","nextStart","templateName","showSelect","callback","get","parseAndTranslate","html","remove","insertAfter","last","timeago","createUserTooltips","makeNumbersHumanReadable"],"mappings":"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","file":"public/src/client/recent.js","sourcesContent":["'use strict';\n\n\ndefine('forum/recent', ['forum/infinitescroll', 'components'], function (infinitescroll, components) {\n\tvar\tRecent = {};\n\n\tvar newTopicCount = 0;\n\tvar newPostCount = 0;\n\n\t$(window).on('action:ajaxify.start', function (ev, data) {\n\t\tif (ajaxify.currentPage !== data.url) {\n\t\t\tRecent.removeListeners();\n\t\t}\n\t});\n\n\tRecent.init = function () {\n\t\tapp.enterRoom('recent_topics');\n\n\t\tRecent.watchForNewPosts();\n\n\t\tRecent.handleCategorySelection();\n\n\t\t$('#new-topics-alert').on('click', function () {\n\t\t\t$(this).addClass('hide');\n\t\t});\n\n\t\tif (!config.usePagination) {\n\t\t\tinfinitescroll.init(Recent.loadMoreTopics);\n\t\t}\n\n\t\t$(window).trigger('action:topics.loaded', { topics: ajaxify.data.topics });\n\t};\n\n\tRecent.watchForNewPosts = function () {\n\t\tnewPostCount = 0;\n\t\tnewTopicCount = 0;\n\t\tRecent.removeListeners();\n\t\tsocket.on('event:new_topic', onNewTopic);\n\t\tsocket.on('event:new_post', onNewPost);\n\t};\n\n\tfunction onNewTopic(data) {\n\t\tif (ajaxify.data.selectedCids && ajaxify.data.selectedCids.indexOf(parseInt(data.cid, 10)) === -1) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (ajaxify.data.selectedFilter && ajaxify.data.selectedFilter.filter === 'watched') {\n\t\t\treturn;\n\t\t}\n\n\t\tif (ajaxify.data.template.category && parseInt(ajaxify.data.cid, 10) !== parseInt(data.cid, 10)) {\n\t\t\treturn;\n\t\t}\n\n\t\tnewTopicCount += 1;\n\t\tRecent.updateAlertText();\n\t}\n\n\tfunction onNewPost(data) {\n\t\tfunction showAlert() {\n\t\t\tnewPostCount += 1;\n\t\t\tRecent.updateAlertText();\n\t\t}\n\n\t\tvar post = data.posts[0];\n\t\tif (!post || !post.topic) {\n\t\t\treturn;\n\t\t}\n\t\tif (parseInt(post.topic.mainPid, 10) === parseInt(post.pid, 10)) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (ajaxify.data.selectedCids && ajaxify.data.selectedCids.indexOf(parseInt(post.topic.cid, 10)) === -1) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (ajaxify.data.selectedFilter && ajaxify.data.selectedFilter.filter === 'new') {\n\t\t\treturn;\n\t\t}\n\n\t\tif (ajaxify.data.template.category && parseInt(ajaxify.data.cid, 10) !== parseInt(post.topic.cid, 10)) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (ajaxify.data.selectedFilter && ajaxify.data.selectedFilter.filter === 'watched') {\n\t\t\tsocket.emit('topics.isFollowed', post.tid, function (err, isFollowed) {\n\t\t\t\tif (err) {\n\t\t\t\t\tapp.alertError(err.message);\n\t\t\t\t}\n\t\t\t\tif (isFollowed) {\n\t\t\t\t\tshowAlert();\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn;\n\t\t}\n\n\t\tshowAlert();\n\t}\n\n\tRecent.handleCategorySelection = function () {\n\t\tfunction getSelectedCids() {\n\t\t\tvar cids = [];\n\t\t\t$('[component=\"category/list\"] [data-cid]').each(function (index, el) {\n\t\t\t\tif ($(el).find('i.fa-check').length) {\n\t\t\t\t\tcids.push(parseInt($(el).attr('data-cid'), 10));\n\t\t\t\t}\n\t\t\t});\n\t\t\tcids.sort(function (a, b) {\n\t\t\t\treturn a - b;\n\t\t\t});\n\t\t\treturn cids;\n\t\t}\n\n\t\t$('[component=\"category/dropdown\"]').on('hidden.bs.dropdown', function () {\n\t\t\tvar cids = getSelectedCids();\n\t\t\tvar changed = ajaxify.data.selectedCids.length !== cids.length;\n\t\t\tajaxify.data.selectedCids.forEach(function (cid, index) {\n\t\t\t\tif (cid !== cids[index]) {\n\t\t\t\t\tchanged = true;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (changed) {\n\t\t\t\tvar url = ajaxify.data.selectedFilter.url;\n\t\t\t\tif (cids.length) {\n\t\t\t\t\turl += '?' + decodeURIComponent($.param({ cid: cids }));\n\t\t\t\t}\n\t\t\t\tajaxify.go(url);\n\t\t\t}\n\t\t});\n\n\t\t$('[component=\"category/list\"]').on('click', '[data-cid]', function (ev) {\n\t\t\tfunction selectChildren(parentCid, flag) {\n\t\t\t\t$('[component=\"category/list\"] [data-parent-cid=\"' + parentCid + '\"] [component=\"category/select/icon\"]').toggleClass('fa-check', flag);\n\t\t\t\t$('[component=\"category/list\"] [data-parent-cid=\"' + parentCid + '\"]').each(function (index, el) {\n\t\t\t\t\tselectChildren($(el).attr('data-cid'), flag);\n\t\t\t\t});\n\t\t\t}\n\t\t\tvar categoryEl = $(this);\n\t\t\tvar cid = $(this).attr('data-cid');\n\t\t\tif (ev.ctrlKey) {\n\t\t\t\tselectChildren(cid, !categoryEl.find('[component=\"category/select/icon\"]').hasClass('fa-check'));\n\t\t\t}\n\t\t\tcategoryEl.find('[component=\"category/select/icon\"]').toggleClass('fa-check');\n\t\t\t$('[component=\"category/list\"] li').first().find('i').toggleClass('fa-check', !getSelectedCids().length);\n\t\t\treturn false;\n\t\t});\n\t};\n\n\tRecent.removeListeners = function () {\n\t\tsocket.removeListener('event:new_topic', onNewTopic);\n\t\tsocket.removeListener('event:new_post', onNewPost);\n\t};\n\n\tRecent.updateAlertText = function () {\n\t\tvar text = '';\n\n\t\tif (newTopicCount === 0) {\n\t\t\tif (newPostCount === 1) {\n\t\t\t\ttext = '[[recent:there-is-a-new-post]]';\n\t\t\t} else if (newPostCount > 1) {\n\t\t\t\ttext = '[[recent:there-are-new-posts, ' + newPostCount + ']]';\n\t\t\t}\n\t\t} else if (newTopicCount === 1) {\n\t\t\tif (newPostCount === 0) {\n\t\t\t\ttext = '[[recent:there-is-a-new-topic]]';\n\t\t\t} else if (newPostCount === 1) {\n\t\t\t\ttext = '[[recent:there-is-a-new-topic-and-a-new-post]]';\n\t\t\t} else if (newPostCount > 1) {\n\t\t\t\ttext = '[[recent:there-is-a-new-topic-and-new-posts, ' + newPostCount + ']]';\n\t\t\t}\n\t\t} else if (newTopicCount > 1) {\n\t\t\tif (newPostCount === 0) {\n\t\t\t\ttext = '[[recent:there-are-new-topics, ' + newTopicCount + ']]';\n\t\t\t} else if (newPostCount === 1) {\n\t\t\t\ttext = '[[recent:there-are-new-topics-and-a-new-post, ' + newTopicCount + ']]';\n\t\t\t} else if (newPostCount > 1) {\n\t\t\t\ttext = '[[recent:there-are-new-topics-and-new-posts, ' + newTopicCount + ', ' + newPostCount + ']]';\n\t\t\t}\n\t\t}\n\n\t\ttext += ' [[recent:click-here-to-reload]]';\n\n\t\t$('#new-topics-alert').translateText(text).removeClass('hide').fadeIn('slow');\n\t\t$('#category-no-topics').addClass('hide');\n\t};\n\n\tRecent.loadMoreTopics = function (direction) {\n\t\tif (direction < 0 || !$('[component=\"category\"]').length) {\n\t\t\treturn;\n\t\t}\n\n\t\tinfinitescroll.loadMore('topics.loadMoreRecentTopics', {\n\t\t\tafter: $('[component=\"category\"]').attr('data-nextstart'),\n\t\t\tcount: config.topicsPerPage,\n\t\t\tcid: utils.params().cid,\n\t\t\tfilter: ajaxify.data.selectedFilter.filter,\n\t\t\tset: $('[component=\"category\"]').attr('data-set') ? $('[component=\"category\"]').attr('data-set') : 'topics:recent',\n\t\t}, function (data, done) {\n\t\t\tif (data.topics && data.topics.length) {\n\t\t\t\tRecent.onTopicsLoaded('recent', data.topics, false, done);\n\t\t\t} else {\n\t\t\t\tdone();\n\t\t\t}\n\t\t\t$('[component=\"category\"]').attr('data-nextstart', data.nextStart);\n\t\t});\n\t};\n\n\tRecent.onTopicsLoaded = function (templateName, topics, showSelect, callback) {\n\t\ttopics = topics.filter(function (topic) {\n\t\t\treturn !components.get('category/topic', 'tid', topic.tid).length;\n\t\t});\n\n\t\tif (!topics.length) {\n\t\t\treturn callback();\n\t\t}\n\n\t\tapp.parseAndTranslate(templateName, 'topics', { topics: topics, showSelect: showSelect }, function (html) {\n\t\t\t$('#category-no-topics').remove();\n\n\t\t\thtml.insertAfter($('[component=\"category/topic\"]').last());\n\t\t\thtml.find('.timeago').timeago();\n\t\t\tapp.createUserTooltips();\n\t\t\tutils.makeNumbersHumanReadable(html.find('.human-readable-number'));\n\t\t\t$(window).trigger('action:topics.loaded', { topics: topics });\n\t\t\tcallback();\n\t\t});\n\t};\n\n\treturn Recent;\n});\n"]}