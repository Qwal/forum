{"version":3,"sources":["public/src/client/chats.js"],"names":["define","components","translator","mousetrap","recentChats","search","messages","Benchpress","Chats","initialised","newMessage","init","env","utils","findBootstrapEnvironment","addSocketListeners","addGlobalEventListeners","addEventListeners","createAutoComplete","$","resizeMainWindow","addHotkeys","document","ready","window","trigger","scrollToBottom","ajaxify","data","hasOwnProperty","get","focus","addSendHandlers","roomId","addPopoutHandler","addActionHandlers","addMemberHandler","find","addRenameHandler","addLeaveHandler","addScrollHandler","uid","addCharactersLeftHandler","on","text","val","app","previousUrl","match","go","userslug","openChat","history","one","el","loading","off","top","scrollHeight","height","scrollTop","start","parseInt","children","length","socket","emit","err","alertError","message","parseMessage","html","currentScrollTop","previousHeight","prepend","timeago","addClass","parent","element","config","maximumChatMessageLength","messageId","this","parents","attr","action","getAttribute","inputEl","prepEdit","delete","restore","bind","activeContact","prev","switchChat","next","e","target","last","lastMid","buttonEl","modal","parse","translate","bootbox","dialog","title","refreshParticipantsList","searchInput","errorEl","require","autocomplete","user","event","selected","username","item","name","translated","confirm","size","callback","ok","chatLib","close","users","listEl","roomName","buttons","save","label","className","submit","newName","sendEl","which","shiftKey","sendMessage","strategies","options","zIndex","listPosition","position","$el","css","_applyPlacement","textcomplete","leave","remove","chat","getModal","roomid","url","self","fetch","relative_path","credentials","then","response","json","payload","parseAndTranslate","setActive","pushState","location","protocol","host","console","warn","status","catch","error","appendChatMessage","template","chats","roomEl","recentEl","rooms","lastUser","fromUser","usernames","unread","updateUserStatus","onChatMessageEdit","titleEl","viewportHeight","fromTop","offset","toggleClass","removeClass"],"mappings":"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","file":"public/src/client/chats.js","sourcesContent":["'use strict';\n\n\ndefine('forum/chats', [\n\t'components',\n\t'translator',\n\t'mousetrap',\n\t'forum/chats/recent',\n\t'forum/chats/search',\n\t'forum/chats/messages',\n\t'benchpress',\n], function (components, translator, mousetrap, recentChats, search, messages, Benchpress) {\n\tvar Chats = {\n\t\tinitialised: false,\n\t};\n\n\tvar newMessage = false;\n\n\tChats.init = function () {\n\t\tvar env = utils.findBootstrapEnvironment();\n\n\t\tif (!Chats.initialised) {\n\t\t\tChats.addSocketListeners();\n\t\t\tChats.addGlobalEventListeners();\n\t\t}\n\n\t\trecentChats.init();\n\n\t\tChats.addEventListeners();\n\t\tChats.createAutoComplete($('[component=\"chat/input\"]'));\n\t\tChats.resizeMainWindow();\n\n\t\tif (env === 'md' || env === 'lg') {\n\t\t\tChats.addHotkeys();\n\t\t}\n\n\t\t$(document).ready(function () {\n\t\t\t$(window).trigger('action:chat.loaded', $('.chats-full'));\n\t\t});\n\n\t\tChats.initialised = true;\n\t\tmessages.scrollToBottom($('.expanded-chat ul.chat-content'));\n\n\t\tsearch.init();\n\n\t\tif (ajaxify.data.hasOwnProperty('roomId')) {\n\t\t\tcomponents.get('chat/input').focus();\n\t\t}\n\t};\n\n\tChats.addEventListeners = function () {\n\t\tChats.addSendHandlers(ajaxify.data.roomId, $('.chat-input'), $('.expanded-chat button[data-action=\"send\"]'));\n\t\tChats.addPopoutHandler();\n\t\tChats.addActionHandlers(components.get('chat/messages'), ajaxify.data.roomId);\n\t\tChats.addMemberHandler(ajaxify.data.roomId, components.get('chat/controls').find('[data-action=\"members\"]'));\n\t\tChats.addRenameHandler(ajaxify.data.roomId, components.get('chat/controls').find('[data-action=\"rename\"]'));\n\t\tChats.addLeaveHandler(ajaxify.data.roomId, components.get('chat/controls').find('[data-action=\"leave\"]'));\n\t\tChats.addScrollHandler(ajaxify.data.roomId, ajaxify.data.uid, $('.chat-content'));\n\t\tChats.addCharactersLeftHandler($('[component=\"chat/main-wrapper\"]'));\n\t};\n\n\tChats.addPopoutHandler = function () {\n\t\t$('[data-action=\"pop-out\"]').on('click', function () {\n\t\t\tvar text = components.get('chat/input').val();\n\t\t\tvar roomId = ajaxify.data.roomId;\n\n\t\t\tif (app.previousUrl && app.previousUrl.match(/chats/)) {\n\t\t\t\tajaxify.go('user/' + ajaxify.data.userslug + '/chats', function () {\n\t\t\t\t\tapp.openChat(roomId, ajaxify.data.uid);\n\t\t\t\t}, true);\n\t\t\t} else {\n\t\t\t\twindow.history.go(-1);\n\t\t\t\tapp.openChat(roomId, ajaxify.data.uid);\n\t\t\t}\n\n\t\t\t$(window).one('action:chat.loaded', function () {\n\t\t\t\tcomponents.get('chat/input').val(text);\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addScrollHandler = function (roomId, uid, el) {\n\t\tvar loading = false;\n\t\tel.off('scroll').on('scroll', function () {\n\t\t\tif (loading) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar top = (el[0].scrollHeight - el.height()) * 0.1;\n\t\t\tif (el.scrollTop() >= top) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tloading = true;\n\t\t\tvar start = parseInt(el.children('[data-mid]').length, 10);\n\t\t\tsocket.emit('modules.chats.getMessages', {\n\t\t\t\troomId: roomId,\n\t\t\t\tuid: uid,\n\t\t\t\tstart: start,\n\t\t\t}, function (err, data) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t\tif (!data) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tmessages.parseMessage(data, function (html) {\n\t\t\t\t\tvar currentScrollTop = el.scrollTop();\n\t\t\t\t\tvar previousHeight = el[0].scrollHeight;\n\t\t\t\t\thtml = $(html);\n\t\t\t\t\tel.prepend(html);\n\t\t\t\t\thtml.find('.timeago').timeago();\n\t\t\t\t\thtml.find('img:not(.not-responsive)').addClass('img-responsive');\n\t\t\t\t\tel.scrollTop((el[0].scrollHeight - previousHeight) + currentScrollTop);\n\t\t\t\t\tloading = false;\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addCharactersLeftHandler = function (parent) {\n\t\tvar element = parent.find('[component=\"chat/input\"]');\n\t\telement.on('keyup', function () {\n\t\t\tparent.find('[component=\"chat/message/length\"]').text(element.val().length);\n\t\t\tparent.find('[component=\"chat/message/remaining\"]').text(config.maximumChatMessageLength - element.val().length);\n\t\t});\n\t};\n\n\tChats.addActionHandlers = function (element, roomId) {\n\t\telement.on('click', '[data-action]', function () {\n\t\t\tvar messageId = $(this).parents('[data-mid]').attr('data-mid');\n\t\t\tvar action = this.getAttribute('data-action');\n\n\t\t\tswitch (action) {\n\t\t\tcase 'edit':\n\t\t\t\tvar inputEl = $('[data-roomid=\"' + roomId + '\"] [component=\"chat/input\"]');\n\t\t\t\tmessages.prepEdit(inputEl, messageId, roomId);\n\t\t\t\tbreak;\n\n\t\t\tcase 'delete':\n\t\t\t\tmessages.delete(messageId, roomId);\n\t\t\t\tbreak;\n\n\t\t\tcase 'restore':\n\t\t\t\tmessages.restore(messageId, roomId);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t});\n\t};\n\n\tChats.addHotkeys = function () {\n\t\tmousetrap.bind('ctrl+up', function () {\n\t\t\tvar activeContact = $('.chats-list .bg-info');\n\t\t\tvar prev = activeContact.prev();\n\n\t\t\tif (prev.length) {\n\t\t\t\tChats.switchChat(prev.attr('data-roomid'));\n\t\t\t}\n\t\t});\n\t\tmousetrap.bind('ctrl+down', function () {\n\t\t\tvar activeContact = $('.chats-list .bg-info');\n\t\t\tvar next = activeContact.next();\n\n\t\t\tif (next.length) {\n\t\t\t\tChats.switchChat(next.attr('data-roomid'));\n\t\t\t}\n\t\t});\n\t\tmousetrap.bind('up', function (e) {\n\t\t\tif (e.target === components.get('chat/input').get(0)) {\n\t\t\t\t// Retrieve message id from messages list\n\t\t\t\tvar message = components.get('chat/messages').find('.chat-message[data-self=\"1\"]').last();\n\t\t\t\tvar lastMid = message.attr('data-mid');\n\t\t\t\tvar inputEl = components.get('chat/input');\n\n\t\t\t\tmessages.prepEdit(inputEl, lastMid, ajaxify.data.roomId);\n\t\t\t}\n\t\t});\n\t};\n\n\tChats.addMemberHandler = function (roomId, buttonEl) {\n\t\tvar modal;\n\n\t\tbuttonEl.on('click', function () {\n\t\t\tBenchpress.parse('partials/modals/manage_room', {}, function (html) {\n\t\t\t\ttranslator.translate(html, function (html) {\n\t\t\t\t\tmodal = bootbox.dialog({\n\t\t\t\t\t\ttitle: '[[modules:chat.manage-room]]',\n\t\t\t\t\t\tmessage: html,\n\t\t\t\t\t});\n\n\t\t\t\t\tmodal.attr('component', 'chat/manage-modal');\n\n\t\t\t\t\tChats.refreshParticipantsList(roomId, modal);\n\n\t\t\t\t\tvar searchInput = modal.find('input');\n\t\t\t\t\tvar errorEl = modal.find('.text-danger');\n\t\t\t\t\trequire(['autocomplete', 'translator'], function (autocomplete, translator) {\n\t\t\t\t\t\tautocomplete.user(searchInput, function (event, selected) {\n\t\t\t\t\t\t\terrorEl.text('');\n\t\t\t\t\t\t\tsocket.emit('modules.chats.addUserToRoom', {\n\t\t\t\t\t\t\t\troomId: roomId,\n\t\t\t\t\t\t\t\tusername: selected.item.user.name,\n\t\t\t\t\t\t\t}, function (err) {\n\t\t\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\t\t\ttranslator.translate(err.message, function (translated) {\n\t\t\t\t\t\t\t\t\t\terrorEl.text(translated);\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tChats.refreshParticipantsList(roomId, modal);\n\t\t\t\t\t\t\t\tsearchInput.val('');\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addLeaveHandler = function (roomId, buttonEl) {\n\t\tbuttonEl.on('click', function () {\n\t\t\tbootbox.confirm({\n\t\t\t\tsize: 'small',\n\t\t\t\ttitle: '[[modules:chat.leave]]',\n\t\t\t\tmessage: '<p>[[modules:chat.leave-prompt]]</p><p class=\"help-block\">[[modules:chat.leave-help]]</p>',\n\t\t\t\tcallback: function (ok) {\n\t\t\t\t\tif (ok) {\n\t\t\t\t\t\tsocket.emit('modules.chats.leave', roomId, function (err) {\n\t\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\t\tapp.alertError(err.message);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t// Return user to chats page. If modal, close modal.\n\t\t\t\t\t\t\tvar modal = buttonEl.parents('.chat-modal');\n\t\t\t\t\t\t\tif (modal.length) {\n\t\t\t\t\t\t\t\trequire(['chat'], function (chatLib) {\n\t\t\t\t\t\t\t\t\tchatLib.close(modal);\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tajaxify.go('chats');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.refreshParticipantsList = function (roomId, modal) {\n\t\tsocket.emit('modules.chats.getUsersInRoom', { roomId: roomId }, function (err, users) {\n\t\t\tvar listEl = modal.find('.list-group');\n\n\t\t\tif (err) {\n\t\t\t\treturn translator.translate('[[error:invalid-data]]', function (translated) {\n\t\t\t\t\tlistEl.find('li').text(translated);\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tBenchpress.parse('partials/modals/manage_room_users', {\n\t\t\t\tusers: users,\n\t\t\t}, function (html) {\n\t\t\t\tlistEl.html(html);\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addRenameHandler = function (roomId, buttonEl, roomName) {\n\t\tvar modal;\n\n\t\tbuttonEl.on('click', function () {\n\t\t\tBenchpress.parse('partials/modals/rename_room', {\n\t\t\t\tname: roomName || ajaxify.data.roomName,\n\t\t\t}, function (html) {\n\t\t\t\ttranslator.translate(html, function (html) {\n\t\t\t\t\tmodal = bootbox.dialog({\n\t\t\t\t\t\ttitle: '[[modules:chat.rename-room]]',\n\t\t\t\t\t\tmessage: html,\n\t\t\t\t\t\tbuttons: {\n\t\t\t\t\t\t\tsave: {\n\t\t\t\t\t\t\t\tlabel: '[[global:save]]',\n\t\t\t\t\t\t\t\tclassName: 'btn-primary',\n\t\t\t\t\t\t\t\tcallback: submit,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\tfunction submit() {\n\t\t\tsocket.emit('modules.chats.renameRoom', {\n\t\t\t\troomId: roomId,\n\t\t\t\tnewName: modal.find('#roomName').val(),\n\t\t\t}, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t};\n\n\tChats.addSendHandlers = function (roomId, inputEl, sendEl) {\n\t\tinputEl.off('keypress').on('keypress', function (e) {\n\t\t\tif (e.which === 13 && !e.shiftKey) {\n\t\t\t\tmessages.sendMessage(roomId, inputEl);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t});\n\n\t\tsendEl.off('click').on('click', function () {\n\t\t\tmessages.sendMessage(roomId, inputEl);\n\t\t\tinputEl.focus();\n\t\t\treturn false;\n\t\t});\n\t};\n\n\tChats.createAutoComplete = function (element) {\n\t\tvar data = {\n\t\t\telement: element,\n\t\t\tstrategies: [],\n\t\t\toptions: {\n\t\t\t\tzIndex: 20000,\n\t\t\t\tlistPosition: function (position) {\n\t\t\t\t\tthis.$el.css(this._applyPlacement(position));\n\t\t\t\t\tthis.$el.css('position', 'absolute');\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t},\n\t\t};\n\n\t\t$(window).trigger('chat:autocomplete:init', data);\n\t\tif (data.strategies.length) {\n\t\t\tdata.element.textcomplete(data.strategies, data.options);\n\t\t}\n\t};\n\n\tChats.leave = function (el) {\n\t\tvar roomId = el.attr('data-roomid');\n\t\tsocket.emit('modules.chats.leave', roomId, function (err) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\t\t\tif (parseInt(roomId, 10) === parseInt(ajaxify.data.roomId, 10)) {\n\t\t\t\tajaxify.go('user/' + ajaxify.data.userslug + '/chats');\n\t\t\t} else {\n\t\t\t\tel.remove();\n\t\t\t}\n\t\t\trequire(['chat'], function (chat) {\n\t\t\t\tvar modal = chat.getModal(roomId);\n\t\t\t\tif (modal.length) {\n\t\t\t\t\tchat.close(modal);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.switchChat = function (roomid) {\n\t\tvar url = 'user/' + ajaxify.data.userslug + '/chats/' + roomid;\n\t\tif (self.fetch) {\n\t\t\tfetch(config.relative_path + '/api/' + url, { credentials: 'include' })\n\t\t\t\t.then(function (response) {\n\t\t\t\t\tif (response.ok) {\n\t\t\t\t\t\tresponse.json().then(function (payload) {\n\t\t\t\t\t\t\tapp.parseAndTranslate('partials/chats/message-window', payload, function (html) {\n\t\t\t\t\t\t\t\tcomponents.get('chat/main-wrapper').html(html);\n\t\t\t\t\t\t\t\thtml.find('.timeago').timeago();\n\t\t\t\t\t\t\t\tChats.resizeMainWindow();\n\t\t\t\t\t\t\t\tajaxify.data = payload;\n\t\t\t\t\t\t\t\tChats.setActive();\n\t\t\t\t\t\t\t\tChats.addEventListeners();\n\t\t\t\t\t\t\t\t$(window).trigger('action:chat.loaded', $('.chats-full'));\n\t\t\t\t\t\t\t\tmessages.scrollToBottom($('.expanded-chat ul.chat-content'));\n\t\t\t\t\t\t\t\tif (history.pushState) {\n\t\t\t\t\t\t\t\t\thistory.pushState({\n\t\t\t\t\t\t\t\t\t\turl: 'user/' + payload.userslug + '/chats/' + payload.roomId,\n\t\t\t\t\t\t\t\t\t}, null, window.location.protocol + '//' + window.location.host + config.relative_path + '/user/' + payload.userslug + '/chats/' + payload.roomId);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.warn('[search] Received ' + response.status);\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.catch(function (error) {\n\t\t\t\t\tconsole.warn('[search] ' + error.message);\n\t\t\t\t});\n\t\t} else {\n\t\t\tajaxify.go(url);\n\t\t}\n\t};\n\n\tChats.addGlobalEventListeners = function () {\n\t\t$(window).on('resize', Chats.resizeMainWindow);\n\t\t$(window).on('mousemove keypress click', function () {\n\t\t\tif (newMessage && ajaxify.data.roomId) {\n\t\t\t\tsocket.emit('modules.chats.markRead', ajaxify.data.roomId);\n\t\t\t\tnewMessage = false;\n\t\t\t}\n\t\t});\n\t};\n\n\tChats.addSocketListeners = function () {\n\t\tsocket.on('event:chats.receive', function (data) {\n\t\t\tif (parseInt(data.roomId, 10) === parseInt(ajaxify.data.roomId, 10)) {\n\t\t\t\tnewMessage = data.self === 0;\n\t\t\t\tdata.message.self = data.self;\n\n\t\t\t\tmessages.appendChatMessage($('.expanded-chat .chat-content'), data.message);\n\t\t\t} else if (ajaxify.data.template.chats) {\n\t\t\t\tvar roomEl = $('[data-roomid=' + data.roomId + ']');\n\n\t\t\t\tif (roomEl.length > 0) {\n\t\t\t\t\troomEl.addClass('unread');\n\t\t\t\t} else {\n\t\t\t\t\tvar recentEl = components.get('chat/recent');\n\t\t\t\t\tBenchpress.parse('partials/chats/recent_room', {\n\t\t\t\t\t\trooms: {\n\t\t\t\t\t\t\troomId: data.roomId,\n\t\t\t\t\t\t\tlastUser: data.message.fromUser,\n\t\t\t\t\t\t\tusernames: data.message.fromUser.username,\n\t\t\t\t\t\t\tunread: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t}, function (html) {\n\t\t\t\t\t\ttranslator.translate(html, function (translated) {\n\t\t\t\t\t\t\trecentEl.prepend(translated);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tsocket.on('event:user_status_change', function (data) {\n\t\t\tapp.updateUserStatus($('.chats-list [data-uid=\"' + data.uid + '\"] [component=\"user/status\"]'), data.status);\n\t\t});\n\n\t\tmessages.onChatMessageEdit();\n\n\t\tsocket.on('event:chats.roomRename', function (data) {\n\t\t\tvar roomEl = components.get('chat/recent/room', data.roomId);\n\t\t\tvar titleEl = roomEl.find('[component=\"chat/title\"]');\n\t\t\tajaxify.data.roomName = data.newName;\n\n\t\t\ttitleEl.text(data.newName);\n\t\t});\n\t};\n\n\tChats.resizeMainWindow = function () {\n\t\tvar viewportHeight = $(window).height();\n\t\tvar fromTop = components.get('chat/main-wrapper').offset().top || components.get('chat/nav-wrapper').offset().top;\n\t\t$('.chats-full').height(viewportHeight - fromTop - 1);\n\n\t\tChats.setActive();\n\t};\n\n\tChats.setActive = function () {\n\t\tif (ajaxify.data.roomId) {\n\t\t\tsocket.emit('modules.chats.markRead', ajaxify.data.roomId);\n\t\t\t$('[data-roomid=\"' + ajaxify.data.roomId + '\"]').toggleClass('unread', false);\n\t\t\t$('.expanded-chat input').focus();\n\t\t}\n\t\t$('.chats-list li').removeClass('bg-info');\n\t\t$('.chats-list li[data-roomid=\"' + ajaxify.data.roomId + '\"]').addClass('bg-info');\n\n\t\tcomponents.get('chat/nav-wrapper').attr('data-loaded', ajaxify.data.roomId ? '1' : '0');\n\t};\n\n\n\treturn Chats;\n});\n"]}