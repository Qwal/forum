"use strict";define("forum/chats",["components","translator","mousetrap","forum/chats/recent","forum/chats/search","forum/chats/messages","benchpress"],function(n,r,a,t,e,s,c){var d={initialised:false};var o=false;d.init=function(){var a=utils.findBootstrapEnvironment();if(!d.initialised){d.addSocketListeners();d.addGlobalEventListeners()}t.init();d.addEventListeners();d.createAutoComplete($('[component="chat/input"]'));d.resizeMainWindow();if(a==="md"||a==="lg"){d.addHotkeys()}$(document).ready(function(){$(window).trigger("action:chat.loaded",$(".chats-full"))});d.initialised=true;s.scrollToBottom($(".expanded-chat ul.chat-content"));e.init();if(ajaxify.data.hasOwnProperty("roomId")){n.get("chat/input").focus()}};d.addEventListeners=function(){d.addSendHandlers(ajaxify.data.roomId,$(".chat-input"),$('.expanded-chat button[data-action="send"]'));d.addPopoutHandler();d.addActionHandlers(n.get("chat/messages"),ajaxify.data.roomId);d.addMemberHandler(ajaxify.data.roomId,n.get("chat/controls").find('[data-action="members"]'));d.addRenameHandler(ajaxify.data.roomId,n.get("chat/controls").find('[data-action="rename"]'));d.addLeaveHandler(ajaxify.data.roomId,n.get("chat/controls").find('[data-action="leave"]'));d.addScrollHandler(ajaxify.data.roomId,ajaxify.data.uid,$(".chat-content"));d.addCharactersLeftHandler($('[component="chat/main-wrapper"]'))};d.addPopoutHandler=function(){$('[data-action="pop-out"]').on("click",function(){var a=n.get("chat/input").val();var t=ajaxify.data.roomId;if(app.previousUrl&&app.previousUrl.match(/chats/)){ajaxify.go("user/"+ajaxify.data.userslug+"/chats",function(){app.openChat(t,ajaxify.data.uid)},true)}else{window.history.go(-1);app.openChat(t,ajaxify.data.uid)}$(window).one("action:chat.loaded",function(){n.get("chat/input").val(a)})})};d.addScrollHandler=function(e,o,n){var i=false;n.off("scroll").on("scroll",function(){if(i){return}var a=(n[0].scrollHeight-n.height())*.1;if(n.scrollTop()>=a){return}i=true;var t=parseInt(n.children("[data-mid]").length,10);socket.emit("modules.chats.getMessages",{roomId:e,uid:o,start:t},function(a,t){if(a){return app.alertError(a.message)}if(!t){return}s.parseMessage(t,function(a){var t=n.scrollTop();var e=n[0].scrollHeight;a=$(a);n.prepend(a);a.find(".timeago").timeago();a.find("img:not(.not-responsive)").addClass("img-responsive");n.scrollTop(n[0].scrollHeight-e+t);i=false})})})};d.addCharactersLeftHandler=function(a){var t=a.find('[component="chat/input"]');t.on("keyup",function(){a.find('[component="chat/message/length"]').text(t.val().length);a.find('[component="chat/message/remaining"]').text(config.maximumChatMessageLength-t.val().length)})};d.addActionHandlers=function(a,o){a.on("click","[data-action]",function(){var a=$(this).parents("[data-mid]").attr("data-mid");var t=this.getAttribute("data-action");switch(t){case"edit":var e=$('[data-roomid="'+o+'"] [component="chat/input"]');s.prepEdit(e,a,o);break;case"delete":s.delete(a,o);break;case"restore":s.restore(a,o);break}})};d.addHotkeys=function(){a.bind("ctrl+up",function(){var a=$(".chats-list .bg-info");var t=a.prev();if(t.length){d.switchChat(t.attr("data-roomid"))}});a.bind("ctrl+down",function(){var a=$(".chats-list .bg-info");var t=a.next();if(t.length){d.switchChat(t.attr("data-roomid"))}});a.bind("up",function(a){if(a.target===n.get("chat/input").get(0)){var t=n.get("chat/messages").find('.chat-message[data-self="1"]').last();var e=t.attr("data-mid");var o=n.get("chat/input");s.prepEdit(o,e,ajaxify.data.roomId)}})};d.addMemberHandler=function(i,a){var s;a.on("click",function(){c.parse("partials/modals/manage_room",{},function(a){r.translate(a,function(a){s=bootbox.dialog({title:"[[modules:chat.manage-room]]",message:a});s.attr("component","chat/manage-modal");d.refreshParticipantsList(i,s);var o=s.find("input");var n=s.find(".text-danger");require(["autocomplete","translator"],function(a,e){a.user(o,function(a,t){n.text("");socket.emit("modules.chats.addUserToRoom",{roomId:i,username:t.item.user.name},function(a){if(a){e.translate(a.message,function(a){n.text(a)})}d.refreshParticipantsList(i,s);o.val("")})})})})})})};d.addLeaveHandler=function(t,e){e.on("click",function(){bootbox.confirm({size:"small",title:"[[modules:chat.leave]]",message:'<p>[[modules:chat.leave-prompt]]</p><p class="help-block">[[modules:chat.leave-help]]</p>',callback:function(a){if(a){socket.emit("modules.chats.leave",t,function(a){if(a){app.alertError(a.message)}var t=e.parents(".chat-modal");if(t.length){require(["chat"],function(a){a.close(t)})}else{ajaxify.go("chats")}})}}})})};d.refreshParticipantsList=function(a,o){socket.emit("modules.chats.getUsersInRoom",{roomId:a},function(a,t){var e=o.find(".list-group");if(a){return r.translate("[[error:invalid-data]]",function(a){e.find("li").text(a)})}c.parse("partials/modals/manage_room_users",{users:t},function(a){e.html(a)})})};d.addRenameHandler=function(a,t,e){var o;t.on("click",function(){c.parse("partials/modals/rename_room",{name:e||ajaxify.data.roomName},function(a){r.translate(a,function(a){o=bootbox.dialog({title:"[[modules:chat.rename-room]]",message:a,buttons:{save:{label:"[[global:save]]",className:"btn-primary",callback:n}}})})})});function n(){socket.emit("modules.chats.renameRoom",{roomId:a,newName:o.find("#roomName").val()},function(a){if(a){return app.alertError(a.message)}})}};d.addSendHandlers=function(t,e,a){e.off("keypress").on("keypress",function(a){if(a.which===13&&!a.shiftKey){s.sendMessage(t,e);return false}});a.off("click").on("click",function(){s.sendMessage(t,e);e.focus();return false})};d.createAutoComplete=function(a){var t={element:a,strategies:[],options:{zIndex:2e4,listPosition:function(a){this.$el.css(this._applyPlacement(a));this.$el.css("position","absolute");return this}}};$(window).trigger("chat:autocomplete:init",t);if(t.strategies.length){t.element.textcomplete(t.strategies,t.options)}};d.leave=function(t){var e=t.attr("data-roomid");socket.emit("modules.chats.leave",e,function(a){if(a){return app.alertError(a.message)}if(parseInt(e,10)===parseInt(ajaxify.data.roomId,10)){ajaxify.go("user/"+ajaxify.data.userslug+"/chats")}else{t.remove()}require(["chat"],function(a){var t=a.getModal(e);if(t.length){a.close(t)}})})};d.switchChat=function(a){var t="user/"+ajaxify.data.userslug+"/chats/"+a;if(self.fetch){fetch(config.relative_path+"/api/"+t,{credentials:"include"}).then(function(a){if(a.ok){a.json().then(function(t){app.parseAndTranslate("partials/chats/message-window",t,function(a){n.get("chat/main-wrapper").html(a);a.find(".timeago").timeago();d.resizeMainWindow();ajaxify.data=t;d.setActive();d.addEventListeners();$(window).trigger("action:chat.loaded",$(".chats-full"));s.scrollToBottom($(".expanded-chat ul.chat-content"));if(history.pushState){history.pushState({url:"user/"+t.userslug+"/chats/"+t.roomId},null,window.location.protocol+"//"+window.location.host+config.relative_path+"/user/"+t.userslug+"/chats/"+t.roomId)}})})}else{console.warn("[search] Received "+a.status)}}).catch(function(a){console.warn("[search] "+a.message)})}else{ajaxify.go(t)}};d.addGlobalEventListeners=function(){$(window).on("resize",d.resizeMainWindow);$(window).on("mousemove keypress click",function(){if(o&&ajaxify.data.roomId){socket.emit("modules.chats.markRead",ajaxify.data.roomId);o=false}})};d.addSocketListeners=function(){socket.on("event:chats.receive",function(a){if(parseInt(a.roomId,10)===parseInt(ajaxify.data.roomId,10)){o=a.self===0;a.message.self=a.self;s.appendChatMessage($(".expanded-chat .chat-content"),a.message)}else if(ajaxify.data.template.chats){var t=$("[data-roomid="+a.roomId+"]");if(t.length>0){t.addClass("unread")}else{var e=n.get("chat/recent");c.parse("partials/chats/recent_room",{rooms:{roomId:a.roomId,lastUser:a.message.fromUser,usernames:a.message.fromUser.username,unread:true}},function(a){r.translate(a,function(a){e.prepend(a)})})}}});socket.on("event:user_status_change",function(a){app.updateUserStatus($('.chats-list [data-uid="'+a.uid+'"] [component="user/status"]'),a.status)});s.onChatMessageEdit();socket.on("event:chats.roomRename",function(a){var t=n.get("chat/recent/room",a.roomId);var e=t.find('[component="chat/title"]');ajaxify.data.roomName=a.newName;e.text(a.newName)})};d.resizeMainWindow=function(){var a=$(window).height();var t=n.get("chat/main-wrapper").offset().top||n.get("chat/nav-wrapper").offset().top;$(".chats-full").height(a-t-1);d.setActive()};d.setActive=function(){if(ajaxify.data.roomId){socket.emit("modules.chats.markRead",ajaxify.data.roomId);$('[data-roomid="'+ajaxify.data.roomId+'"]').toggleClass("unread",false);$(".expanded-chat input").focus()}$(".chats-list li").removeClass("bg-info");$('.chats-list li[data-roomid="'+ajaxify.data.roomId+'"]').addClass("bg-info");n.get("chat/nav-wrapper").attr("data-loaded",ajaxify.data.roomId?"1":"0")};return d});
//# sourceMappingURL=public/src/client/chats.js.map