"use strict";define("composer",["taskbar","translator","composer/controls","composer/uploads","composer/formatting","composer/drafts","composer/tags","composer/categoryList","composer/preview","composer/resize","composer/autocomplete","scrollStop"],function(c,u,e,m,r,g,v,h,b,l,s,p){var w={active:undefined,posts:{},bsEnvironment:undefined,formatting:undefined};$(window).off("resize",t).on("resize",t);t();$(window).on("action:composer.topics.post",function(e,t){localStorage.removeItem("category:"+t.data.cid+":bookmark");localStorage.removeItem("category:"+t.data.cid+":bookmark:clicked")});$(window).on("popstate",function(){var e=w.bsEnvironment;if(w.active&&(e==="xs"||e==="sm")){if(!w.posts[w.active].modified){w.discard(w.active);return}u.translate("[[modules:composer.discard]]",function(e){bootbox.confirm(e,function(e){if(e){w.discard(w.active)}})})}});function y(){var e=w.bsEnvironment;if(ajaxify.data.template.compose===true||e==="xs"||e==="sm"){history.back()}}function t(){var e=utils.findBootstrapEnvironment();if(w.active!==undefined){l.reposition($("#cmp-uuid-"+w.active));if((e==="md"||e==="lg")&&window.location.pathname.startsWith("/compose")){history.back()}else if((e==="xs"||e==="sm")&&!window.location.pathname.startsWith("/compose")){f()}}w.bsEnvironment=e}function o(e){var t,i;if(e.hasOwnProperty("cid")){t="cid"}else if(e.hasOwnProperty("tid")){t="tid"}else if(e.hasOwnProperty("pid")){t="pid"}i=e[t];for(var o in w.posts){if(w.posts[o].hasOwnProperty(t)&&i===w.posts[o][t]){return o}}return false}function n(t){var i=utils.generateUUID(),e=o(t);if(e){c.updateActive(e);return w.load(e)}u.translate("[[topic:composer.new_topic]]",function(e){c.push("composer",i,{title:t.title?t.title:e})});if(0!==parseInt(app.user.uid,10)){if(t.hasOwnProperty("cid")){t.save_id=["composer",app.user.uid,"cid",t.cid].join(":")}else if(t.hasOwnProperty("tid")){t.save_id=["composer",app.user.uid,"tid",t.tid].join(":")}else if(t.hasOwnProperty("pid")){t.save_id=["composer",app.user.uid,"pid",t.pid].join(":")}}g.updateVisibility("available",t.save_id,true);g.updateVisibility("open",t.save_id,true);w.posts[i]=t;w.load(i)}function x(e,t){$("#cmp-uuid-"+e).find(".composer-submit").removeAttr("disabled");app.alert({type:"danger",timeout:3e3,title:"",message:t,alert_id:"post_error"})}w.findByTid=function(e){for(var t in w.posts){if(w.posts.hasOwnProperty(t)&&w.posts[t].hasOwnProperty("tid")&&parseInt(w.posts[t].tid,10)===parseInt(e,10)){return t}}return null};w.addButton=function(e,t,i){r.addButton(e,t,i)};w.newTopic=function(e){var t={action:"topics.post",cid:e.cid,title:e.title||"",body:e.body||"",tags:e.tags||[],modified:false,isMain:true};$(window).trigger("filter:composer.topic.push",{data:e,pushData:t});n(t)};w.addQuote=function(e,t,i,o,n,a,r){r=r||w.active;var s=(o||"").replace(/([\\`*_{}\[\]()#+\-.!])/g,"\\$1").replace(/\[/g,"&#91;").replace(/\]/g,"&#93;").replace(/%/g,"&#37;").replace(/,/g,"&#44;");if(a){a="> "+a.replace(/\n/g,"\n> ")+"\n\n"}var d="["+s+"]("+config.relative_path+"/post/"+(i||t)+")";if(r===undefined){if(o&&(i||t)){w.newReply(e,t,o,"[[modules:composer.user_said_in, "+n+", "+d+"]]\n"+a)}else{w.newReply(e,t,o,"[[modules:composer.user_said, "+n+"]]\n"+a)}return}else if(r!==w.active){w.load(r)}var c=$("#cmp-uuid-"+r);var l=c.find("textarea");var p=l.val();if(o&&(i||t)){u.translate("[[modules:composer.user_said_in, "+n+", "+d+"]]\n",config.defaultLang,f)}else{u.translate("[[modules:composer.user_said, "+n+"]]\n",config.defaultLang,f)}function f(e){w.posts[r].body=(p.length?p+"\n\n":"")+e+a;l.val(w.posts[r].body);P(c);b.render(c)}};w.newReply=function(t,i,o,e){u.translate(e,config.defaultLang,function(e){n({action:"posts.reply",tid:t,toPid:i,title:o,body:e,modified:false,isMain:false})})};w.editPost=function(i){socket.emit("plugins.composer.push",i,function(e,t){if(e){return app.alertError(e.message)}n({action:"posts.edit",pid:i,uid:t.uid,handle:t.handle,title:t.title,body:t.body,modified:false,isMain:t.isMain,thumb:t.thumb,tags:t.tags})})};w.load=function(i){var e=$("#cmp-uuid-"+i);if(e.length){T(i);l.reposition(e);P(e);k()}else{if(w.formatting){a(i)}else{socket.emit("plugins.composer.getFormattingOptions",function(e,t){w.formatting=t;a(i)})}}};w.enhance=function(e,i,t){if(!i&&!t){i=utils.generateUUID();w.posts[i]=t=ajaxify.data;e.attr("id","cmp-uuid-"+i)}var o=e.find("textarea");var n=g.getDraft(t.save_id);var a=e.find(".composer-submit");h.init(e,w.posts[i]);r.addHandler(e);r.addComposerButtons();b.handleToggler(e);e.find(".img-upload-btn").removeClass("hide");e.find("#files.lt-ie9").removeClass("hide");if(config.allowFileUploads){e.find(".file-upload-btn").removeClass("hide");e.find("#files.lt-ie9").removeClass("hide")}m.initialize(i);if(config.allowTopicsThumbnail&&t.isMain){m.toggleThumbEls(e,w.posts[i].thumb||"")}v.init(e,w.posts[i]);s.init(e,i);e.on("change","input, textarea",function(){w.posts[i].modified=true});a.on("click",function(e){e.preventDefault();e.stopPropagation();$(this).attr("disabled",true);_(i)});e.keypress(function(e){var t=e.which?e.which:e.keyCode;if((t===10||t==13)&&e.ctrlKey){a.attr("disabled",true);_(i);return false}return true});e.find(".composer-discard").on("click",function(e){e.preventDefault();if(!w.posts[i].modified){y();return w.discard(i)}var t=$(this).prop("disabled",true);u.translate("[[modules:composer.discard]]",function(e){bootbox.confirm(e,function(e){if(e){y();w.discard(i)}t.prop("disabled",false)})})});o.on("input propertychange",function(){b.render(e)});o.on("scroll",function(){b.matchScroll(e)});b.render(e,function(){b.matchScroll(e)});o.val(n?n:t.body);g.init(e,t);d(e);P(e);if(typeof screenfull!=="undefined"&&!screenfull.enabled){$('[data-format="zen"]').addClass("hidden")}$(window).trigger("action:composer.enhanced",{postContainer:e})};function a(r){var s=w.posts[r];var e=config.allowTopicsThumbnail&&s.isMain,t=s?s.hasOwnProperty("cid"):false,i=s?!!s.isMain:false,o=s?!!s.pid:false,n=s?parseInt(s.uid,10)===0:false;var a=s.title.replace(/%/g,"&#37;").replace(/,/g,"&#44;");var d={title:a,mobile:w.bsEnvironment==="xs"||w.bsEnvironment==="sm",resizable:true,allowTopicsThumbnail:e,isTopicOrMain:t||i,minimumTagLength:config.minimumTagLength,maximumTagLength:config.maximumTagLength,isTopic:t,isEditing:o,showHandleInput:config.allowGuestHandles&&(app.user.uid===0||o&&n&&app.user.isAdmin),handle:s?s.handle||"":undefined,formatting:w.formatting,tagWhitelist:ajaxify.data.tagWhitelist,privileges:app.user.privileges};if(d.mobile){f()}$(window).trigger("filter:composer.create",{postData:s,createData:d});app.parseAndTranslate("composer",d,function(e){if($("#cmp-uuid-"+r).length){return}e=$(e);e.find(".title").each(function(){$(this).text(u.unescape($(this).text()))});e.attr("id","cmp-uuid-"+r);$(document.body).append(e);var t=$(e[0]);l.reposition(t);w.enhance(t,r,s);T(r);t.on("click",function(){if(!c.isActive(r)){c.updateActive(r)}});l.handleResize(t);if(w.bsEnvironment==="xs"||w.bsEnvironment==="sm"){var i=t.find(".composer-submit"),o=t.find(".mobile-navbar .composer-submit"),n=t.find(".write"),a=n.attr("tabindex");i.removeAttr("tabindex");o.attr("tabindex",parseInt(a,10)+1);$(".category-name-container").on("click",function(){$(".category-selector").toggleClass("open")})}$(window).trigger("action:composer.loaded",{post_uuid:r,composerData:w.posts[r]});p.apply(t.find(".write"));P(t);k()})}function f(){var e="compose?p="+window.location.pathname,t=window.location.pathname.slice(1);if(t.startsWith(config.relative_path.slice(1))){t=t.slice(config.relative_path.length)}window.history.replaceState({url:null,returnPath:t},t,config.relative_path+"/"+t);window.history.pushState({url:e},e,config.relative_path+"/"+e)}function d(e){var i=e.find(".help");socket.emit("plugins.composer.renderHelp",function(e,t){if(!e&&t&&t.length>0){i.removeClass("hidden");i.on("click",function(){bootbox.alert(t)})}})}function T(e){if(w.active&&w.active!==e){w.minimize(w.active)}w.active=e}function P(t){setTimeout(function(){var e=t.find("input.title");if(e.length){e.focus()}else{t.find("textarea").focus().putCursorAtEnd()}},1)}function _(i){var o=w.posts[i];var n=$("#cmp-uuid-"+i);var e=n.find(".handle");var t=n.find(".title");var a=n.find("textarea");var r=n.find("input#topic-thumb-url");var s=o.hasOwnProperty("template")&&o.template.compose===true;t.val(t.val().trim());a.val(utils.rtrim(a.val()));if(r.length){r.val(r.val().trim())}var d=o.action;var c=(o.hasOwnProperty("cid")||parseInt(o.pid,10))&&n.find("input.title").length;var l=!c||c&&parseInt(o.cid,10);if(m.inProgress[i]&&m.inProgress[i].length){return x(i,"[[error:still-uploading]]")}else if(c&&t.val().length<parseInt(config.minimumTitleLength,10)){return x(i,"[[error:title-too-short, "+config.minimumTitleLength+"]]")}else if(c&&t.val().length>parseInt(config.maximumTitleLength,10)){return x(i,"[[error:title-too-long, "+config.maximumTitleLength+"]]")}else if(d==="topics.post"&&!l){return x(i,"[[error:category-not-selected]]")}else if(c&&v.getTags(i)&&v.getTags(i).length<parseInt(config.minimumTagsPerTopic,10)){return x(i,"[[error:not-enough-tags, "+config.minimumTagsPerTopic+"]]")}else if(a.val().length<parseInt(config.minimumPostLength,10)){return x(i,"[[error:content-too-short, "+config.minimumPostLength+"]]")}else if(a.val().length>parseInt(config.maximumPostLength,10)){return x(i,"[[error:content-too-long, "+config.maximumPostLength+"]]")}var p={};if(d==="topics.post"){p={handle:e?e.val():undefined,title:t.val(),content:a.val(),thumb:r.val()||"",cid:h.getSelectedCid(),tags:v.getTags(i)}}else if(d==="posts.reply"){p={tid:o.tid,handle:e?e.val():undefined,content:a.val(),toPid:o.toPid}}else if(d==="posts.edit"){p={pid:o.pid,handle:e?e.val():undefined,content:a.val(),title:t.val(),thumb:r.val()||"",tags:v.getTags(i)}}$(window).trigger("action:composer.submit",{composerEl:n,action:d,composerData:p,postData:o});var f=$('#taskbar [data-uuid="'+i+'"] i');var u=n.find(".write");f.removeClass("fa-plus").addClass("fa-circle-o-notch fa-spin");w.minimize(i);u.prop("readonly",true);socket.emit(d,p,function(e,t){n.find(".composer-submit").removeAttr("disabled");if(e){if(e.message==="[[error:email-not-confirmed]]"){return app.showEmailConfirmWarning(e)}return app.alertError(e.message)}w.discard(i);g.removeDraft(o.save_id);if(t.queued){bootbox.alert(t.message)}else{if(d==="topics.post"){ajaxify.go("topic/"+t.slug,undefined,s||w.bsEnvironment==="xs"||w.bsEnvironment==="sm"?true:false)}else if(d==="posts.reply"){if(s||w.bsEnvironment==="xs"||w.bsEnvironment==="sm"){window.history.back()}else if(ajaxify.data.template.topic){if(parseInt(o.tid,10)!==parseInt(ajaxify.data.tid,10)){ajaxify.go("post/"+t.pid)}}else{ajaxify.go("post/"+t.pid)}}else{y()}}$(window).trigger("action:composer."+d,{composerData:p,data:t})})}function k(){$("html").addClass("composing")}function i(){$("body").css({paddingBottom:0});$("html").removeClass("composing")}w.discard=function(e){if(w.posts[e]){var t=$("#cmp-uuid-"+e);t.find(".write").textcomplete("destroy");t.remove();g.removeDraft(w.posts[e].save_id);delete w.posts[e];w.active=undefined;c.discard("composer",e);$('[data-action="post"]').removeAttr("disabled");$(window).trigger("action:composer.discard")}i()};w.minimize=function(e){var t=$("#cmp-uuid-"+e);t.css("visibility","hidden");w.active=undefined;c.minimize("composer",e);i()};return w});
//# sourceMappingURL=node_modules/nodebb-plugin-composer-default/static/lib/composer.js.map