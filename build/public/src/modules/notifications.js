"use strict";define("notifications",["sounds","translator","components","navigator","benchpress"],function(i,e,o,r,s){var f={};var c={};f.prepareDOM=function(){var a=o.get("notifications");var e=a.children("a");var n=o.get("notifications/list");e.on("click",function(t){t.preventDefault();if(a.hasClass("open")){return}f.loadNotifications(n)});n.on("click","[data-nid]",function(t){var a=$(this);if(l(a)){t.stopPropagation();t.preventDefault();e.dropdown("toggle")}var n=a.hasClass("unread");if(!n){return}var i=a.attr("data-nid");socket.emit("notifications.markRead",i,function(t){if(t){return app.alertError(t.message)}if(c[i]){delete c[i]}})});a.on("click",".mark-all-read",f.markAllRead);n.on("click",".mark-read",function(){var a=$(this).parent();var n=a.hasClass("unread");var i=a.attr("data-nid");socket.emit("notifications.mark"+(n?"Read":"Unread"),i,function(t){if(t){return app.alertError(t.message)}a.toggleClass("unread");if(n&&c[i]){delete c[i]}});return false});socket.on("event:new_notification",function(t){var a={alert_id:"new_notif",title:"[[notifications:new_notification]]",timeout:2e3};if(t.path){a.message=t.bodyShort;a.type="info";a.clickfn=function(){if(t.path.startsWith("http")||t.path.startsWith("https")){window.location.href=t.path}else{window.location.href=window.location.protocol+"//"+window.location.host+config.relative_path+t.path}}}else{a.message="[[notifications:you_have_unread_notifications]]";a.type="warning"}app.alert(a);app.refreshTitle();if(ajaxify.currentPage==="notifications"){ajaxify.refresh()}socket.emit("notifications.getCount",function(t,a){if(t){return app.alertError(t.message)}f.updateNotifCount(a)});if(!c[t.nid]){i.play("notification",t.nid);c[t.nid]=true}});socket.on("event:notifications.updateCount",function(t){f.updateNotifCount(t)})};function l(t){var a=t.attr("data-pid");var n=t.attr("data-path");var i=o.get("post","pid",a);if(n.startsWith(config.relative_path+"/post/")&&a&&i.length&&ajaxify.data.template.topic){r.scrollToIndex(i.attr("data-index"),true);return true}return false}f.loadNotifications=function(i){socket.emit("notifications.get",null,function(t,a){if(t){return app.alertError(t.message)}var n=a.unread.concat(a.read).sort(function(t,a){return parseInt(t.datetime,10)>parseInt(a.datetime,10)?-1:1});e.toggleTimeagoShorthand(function(){for(var t=0;t<n.length;t+=1){n[t].timeago=$.timeago(new Date(parseInt(n[t].datetime,10)))}e.toggleTimeagoShorthand();s.parse("partials/notifications_list",{notifications:n},function(t){i.translateHtml(t)})})})};f.updateNotifCount=function(t){var a=o.get("notifications/icon");t=Math.max(0,t);if(t>0){a.removeClass("fa-bell-o").addClass("fa-bell")}else{a.removeClass("fa-bell").addClass("fa-bell-o")}a.toggleClass("unread-count",t>0);a.attr("data-content",t>99?"99+":t);var n={count:t,updateFavicon:true};$(window).trigger("action:notification.updateCount",n);if(n.updateFavicon){Tinycon.setBubble(t>99?"99+":t)}};f.markAllRead=function(){socket.emit("notifications.markAllRead",function(t){if(t){app.alertError(t.message)}c={}})};return f});
//# sourceMappingURL=public/src/modules/notifications.js.map