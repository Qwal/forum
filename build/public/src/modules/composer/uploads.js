"use strict";define("composer/uploads",["composer/preview","composer/categoryList","translator"],function(c,d,m){var g={inProgress:{}};var v="";g.initialize=function(e){a(e);n(e);t(e);i(e);m.translate("[[modules:composer.uploading, "+0+"%]]",function(e){v=e})};function t(a){var e=$("#cmp-uuid-"+a);e.find("#files").on("change",function(e){var t=(e.target||{}).files||($(this).val()?[{name:$(this).val(),type:utils.fileMimeType($(this).val())}]:null);if(t){s({files:t,post_uuid:a,route:"/api/post/upload"})}});e.find("#topic-thumb-file").on("change",function(e){var t=(e.target||{}).files||($(this).val()?[{name:$(this).val(),type:utils.fileMimeType($(this).val())}]:null),i;if(t){if(window.FormData){i=new FormData;for(var r=0;r<t.length;++r){i.append("files[]",t[r],t[r].name)}}o({files:t,post_uuid:a,route:"/api/topic/thumb/upload",formData:i})}})}function i(e){var i=$("#cmp-uuid-"+e);i.on("click",".topic-thumb-clear-btn",function(e){i.find("input#topic-thumb-url").val("").trigger("change");r(i.find("input#topic-thumb-file"));$(this).addClass("hide");e.preventDefault()});i.on("paste change keypress","input#topic-thumb-url",function(){var t=$(this);setTimeout(function(){var e=t.val();if(e){i.find(".topic-thumb-clear-btn").removeClass("hide")}else{r(i.find("input#topic-thumb-file"));i.find(".topic-thumb-clear-btn").addClass("hide")}i.find("img.topic-thumb-preview").attr("src",e)},100)})}g.toggleThumbEls=function(t,e){var i=t.find(".topic-thumb-toggle-btn");t.find("input#topic-thumb-url").val(e);t.find("img.topic-thumb-preview").attr("src",e);if(e){t.find(".topic-thumb-clear-btn").removeClass("hide")}i.removeClass("hide");i.off("click").on("click",function(){var e=t.find(".topic-thumb-container");e.toggleClass("hide",!e.hasClass("hide"))})};function r(e){e.wrap("<form />").closest("form").get(0).reset();e.unwrap()}function a(a){function e(){if(r){return}o.css("top","0px");o.css("height",n.height()+"px");o.css("line-height",n.height()+"px");o.show();o.on("dragleave",function(){o.hide();o.off("dragleave")})}function t(e){e.preventDefault();var t=e.originalEvent.dataTransfer.files;var i;if(t.length){if(window.FormData){i=new FormData;for(var r=0;r<t.length;++r){i.append("files[]",t[r],t[r].name)}}s({files:t,post_uuid:a,route:"/api/post/upload",formData:i})}o.hide();return false}function i(e){e.preventDefault();return false}var r=false;var n=$("#cmp-uuid-"+a);var o=n.find(".imagedrop");$(document).off("dragstart").on("dragstart",function(){r=true}).off("dragend").on("dragend",function(){r=false});n.on("dragenter",e);o.on("dragover",i);o.on("dragenter",i);o.on("drop",t)}function n(a){$(window).off("paste").on("paste",function(e){var t=(e.clipboardData||e.originalEvent.clipboardData||{}).items;[].some.call(t,function(e){var t=e.getAsFile();if(!t){return false}var i=utils.generateUUID()+"-"+t.name;var r=null;if(window.FormData){r=new FormData;r.append("files[]",t,i)}s({files:[t],fileNames:[i],post_uuid:a,route:"/api/post/upload",formData:r});return true})})}function h(e){return e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}function b(e,t,i){return e.slice(0,t)+i+e.slice(t)}function s(e){var n=e.files;var t=e.post_uuid;var i=$("#cmp-uuid-"+t);var o=i.find("textarea");var r=o.val();var s=i.find("#fileForm");var u=false;s.attr("action",config.relative_path+e.route);var f=d.getSelectedCid();if(!f&&ajaxify.data.cid){f=ajaxify.data.cid}for(var a=0;a<n.length;++a){var l=n[a].type.match(/image./);if(l&&!app.user.privileges["upload:post:image"]||!l&&!app.user.privileges["upload:post:file"]){return app.alertError("[[error:no-privileges]]")}}var p=[];for(var a=0;a<n.length;++a){p.push(a+"_"+Date.now()+"_"+(e.fileNames?e.fileNames[a]:n[a].name));var l=n[a].type.match(/image./);if(n[a].size>parseInt(config.maximumFileSize,10)*1024){s[0].reset();return app.alertError("[[error:file-too-big, "+config.maximumFileSize+"]]")}r=b(r,o.getCursorPosition(),(l?"!":"")+"["+p[a]+"]("+v+") ")}i.find('[data-action="post"]').prop("disabled",true);o.val(r);s.off("submit").submit(function(){function a(e,t){var i=o.val();var r=new RegExp(h(e)+"]\\([^)]+\\)","g");o.val(i.replace(r,e+"]("+t+")"))}g.inProgress[t]=g.inProgress[t]||[];g.inProgress[t].push(1);if(e.formData){e.formData.append("cid",f)}$(this).ajaxSubmit({headers:{"x-csrf-token":config.csrf_token},resetForm:true,clearForm:true,formData:e.formData,data:{cid:f},error:function(e){i.find('[data-action="post"]').prop("disabled",false);D(e)},uploadProgress:function(e,t,i,r){m.translate("[[modules:composer.uploading, "+r+"%]]",function(e){if(u){return}for(var t=0;t<n.length;++t){a(p[t],e)}})},success:function(e){u=true;if(e&&e.length){for(var t=0;t<e.length;++t){a(p[t],e[t].url)}}c.render(i);o.focus();i.find('[data-action="post"]').prop("disabled",false)},complete:function(){s[0].reset();g.inProgress[t].pop()}});return false});s.submit()}function o(e){var t=e.post_uuid,i=$("#cmp-uuid-"+t),r=i.find(".topic-thumb-spinner"),a=i.find("#thumbForm");a.attr("action",config.relative_path+e.route);a.off("submit").submit(function(){r.removeClass("hide");g.inProgress[t]=g.inProgress[t]||[];g.inProgress[t].push(1);$(this).ajaxSubmit({headers:{"x-csrf-token":config.csrf_token},formData:e.formData,error:D,success:function(e){i.find("#topic-thumb-url").val((e[0]||{}).url||"").trigger("change")},complete:function(){g.inProgress[t].pop();r.addClass("hide")}});return false});a.submit()}function D(e){var t=e.responseJSON&&e.responseJSON.error||"[[error:parse-error]]";if(e&&e.status===413){t=e.statusText||"Request Entity Too Large"}app.alertError(t)}return g});
//# sourceMappingURL=node_modules/nodebb-plugin-composer-default/static/lib/composer/uploads.js.map