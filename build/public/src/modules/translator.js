"use strict";(function(r){function e(e,t){return Promise.resolve(jQuery.getJSON(config.relative_path+"/assets/language/"+e+"/"+t+".json?"+config["cache-buster"]))}var n=function(){console.warn.apply(console,arguments)};if(typeof define==="function"&&define.amd){define("translator",[],function(){return r(utils,e,n)})}else if(typeof module==="object"&&module.exports){(function(){var a=require("../../../src/languages");if(global.env==="development"){var t=require("winston");n=function(e){t.warn(e)}}function e(e,t){return new Promise(function(r,n){a.get(e,t,function(e,t){if(e){n(e)}else{r(t)}})})}module.exports=r(require("../utils"),e,n)})()}})(function(i,e,l){var s=Object.assign||jQuery.extend;function c(e){return i.escapeHTML(i.decodeHTMLEntities(String(e).replace(/[\s\xa0]+/g," ").replace(/^\s+|\s+$/g,"")))}var o=function(){function a(r){var e=this;if(!r){throw new TypeError("Parameter `language` must be a language string. Received "+r+(r===""?"(empty string)":""))}e.modules=Object.keys(a.moduleFactories).map(function(e){var t=a.moduleFactories[e];return[e,t(r)]}).reduce(function(e,t){var r=t[0];var n=t[1];e[r]=n;return e},{});e.lang=r;e.translations={}}a.prototype.load=e;a.prototype.translate=function e(t){var r="a-zA-Z0-9\\-_.\\/";var n=new RegExp("["+r+"]");var a=new RegExp("[^"+r+"\\]]");var i=0;var s=0;var o=t.length;var u=[];var l=false;function c(e){var t=e.length;var r=[];var n=0;var a=0;var i=0;while(n+2<=t){if(e[n]==="["&&e[n+1]==="["){i+=1;n+=1}else if(e[n]==="]"&&e[n+1]==="]"){i-=1;n+=1}else if(i===0&&e[n]===","&&e[n-1]!=="\\"){r.push(e.slice(a,n).trim());n+=1;a=n}n+=1}r.push(e.slice(a,n+1).trim());return r}i=t.indexOf("[[",i);while(i+2<=o&&i!==-1){u.push(t.slice(s,i));i+=2;s=i;l=true;var f=0;var g;var v;var p=false;var h=false;var m=false;var d=false;while(i+2<=o){g=t[i];v=t[i+1];if(!p&&n.test(g)){p=true;i+=1}else if(p&&!h&&g===":"){h=true;i+=1}else if(h&&!m&&n.test(g)){m=true;i+=1}else if(m&&!d&&g===","){d=true;i+=1}else if(!(p&&h&&m&&d)&&a.test(g)){i+=1;s-=2;l=false;if(f>0){f-=1}else{break}}else if(g==="["&&v==="["){f+=1;i+=2}else if(g==="]"&&v==="]"){if(f===0){var y=t.slice(s,i);var j=c(y);var w=j[0];var b=j.slice(1);var T="";if(b&&b.length){T=this.translate(y)}u.push(this.translateKey(w,b,T));i+=2;s=i;l=false;break}f-=1;i+=2}else{i+=1}}i=t.indexOf("[[",i)}var q=t.slice(s);if(l){q=this.translate(q)}u.push(q);return Promise.all(u).then(function(e){return e.join("")})};a.prototype.translateKey=function e(r,n,a){var i=this;var t=r.split(":",2);var s=t[0];var o=t[1];if(i.modules[s]){return Promise.resolve(i.modules[s](o,n))}if(s&&!o){l('Missing key in translation token "'+r+'"');return Promise.resolve("[["+s+"]]")}var u=this.getTranslation(s,o);return u.then(function(t){if(!t){l('Missing translation "'+r+'"');return a||o}var e=n.map(function(e){return i.translate(c(e))});return Promise.all(e).then(function(e){var n=t;e.forEach(function(e,t){var r=e.replace(/%(?=\d)/g,"&#37;").replace(/\\,/g,"&#44;");n=n.replace(new RegExp("%"+(t+1),"g"),r)});return n})})};a.prototype.getTranslation=function e(t,r){var n;if(!t){l("[translator] Parameter `namespace` is "+t+(t===""?"(empty string)":""));n=Promise.resolve({})}else{this.translations[t]=this.translations[t]||this.load(this.lang,t).catch(function(){return{}});n=this.translations[t]}if(r){return n.then(function(e){return e[r]})}return n};function o(e){var a=[];function i(e){if(e.nodeType===3){a.push(e)}else{for(var t=0,r=e.childNodes,n=r.length;t<n;t+=1){i(r[t])}}}i(e);return a}a.prototype.translateInPlace=function e(n,t){t=t||["placeholder","title"];var a=o(n);var r=a.map(function(e){return e.nodeValue}).join("  ||  ");var i=t.reduce(function(e,t){var r=Array.prototype.map.call(n.querySelectorAll("["+t+'*="[["]'),function(e){return[t,e]});return e.concat(r)},[]);var s=i.map(function(e){return e[1].getAttribute(e[0])}).join("  ||  ");return Promise.all([this.translate(r),this.translate(s)]).then(function(e){var t=e[0];var r=e[1];if(t){t.split("  ||  ").forEach(function(e,t){$(a[t]).replaceWith(e)})}if(r){r.split("  ||  ").forEach(function(e,t){i[t][1].setAttribute(i[t][0],e)})}})};a.getLanguage=function e(){var t;if(typeof window==="object"&&window.config&&window.utils){t=i.params().lang||config.userLang||config.defaultLang||"en-GB"}else{var r=require("../../../src/meta");t=r.config.defaultLang||"en-GB"}return t};a.create=function e(t){if(!t){t=a.getLanguage()}a.cache[t]=a.cache[t]||new a(t);return a.cache[t]};a.cache={};a.registerModule=function e(r,n){a.moduleFactories[r]=n;Object.keys(a.cache).forEach(function(e){var t=a.cache[e];t.modules[r]=n(t.lang)})};a.moduleFactories={};a.removePatterns=function e(t){var r=t.length;var n=0;var a=0;var i=0;var s="";var o;while(n<r){o=t.slice(n,n+2);if(o==="[["){if(i===0){s+=t.slice(a,n)}i+=1;n+=2}else if(o==="]]"){i-=1;n+=2;if(i===0){a=n}}else{n+=1}}s+=t.slice(a,n);return s};a.escape=function e(t){return typeof t==="string"?t.replace(/\[\[/g,"&lsqb;&lsqb;").replace(/\]\]/g,"&rsqb;&rsqb;"):t};a.unescape=function e(t){return typeof t==="string"?t.replace(/&lsqb;|\\\[/g,"[").replace(/&rsqb;|\\\]/g,"]"):t};a.compile=function e(){var t=Array.prototype.slice.call(arguments,0).map(function(e){return String(e).replace(/%/g,"&#37;").replace(/,/g,"&#44;")});return"[["+t.join(", ")+"]]"};return a}();var u={Translator:o,compile:o.compile,escape:o.escape,unescape:o.unescape,getLanguage:o.getLanguage,translate:function e(t,r,n){var a=n;var i=r;if(typeof r==="function"){a=r;i=null}if(!(typeof t==="string"||t instanceof String)||t===""){return a("")}return o.create(i).translate(t).then(function(e){if(a){setTimeout(a,0,e)}return e},function(e){l("Translation failed: "+e.stack)})},addTranslation:function e(t,r,n){o.create(t).getTranslation(r).then(function(e){s(e,n)})},getTranslations:function e(t,r,n){n=n||function(){};o.create(t).getTranslation(r).then(n)},load:function e(t,r,n){u.getTranslations(t,r,n)},toggleTimeagoShorthand:function e(t){function r(){var e=s({},jQuery.timeago.settings.strings);jQuery.timeago.settings.strings=s({},u.timeagoShort);u.timeagoShort=s({},e);if(typeof t==="function"){t()}}if(!u.timeagoShort){var n=i.userLangToTimeagoCode(config.userLang);var a=s({},jQuery.timeago.settings.strings);jQuery.getScript(config.relative_path+"/assets/vendor/jquery/timeago/locales/jquery.timeago."+n+"-short.js").done(function(){u.timeagoShort=s({},jQuery.timeago.settings.strings);jQuery.timeago.settings.strings=s({},a);r()})}else{r()}},prepareDOM:function e(){u.translate("[[language:dir]]",function(e){if(e&&!$("html").attr("data-dir")){jQuery("html").css("direction",e).attr("data-dir",e)}})}};return u});
//# sourceMappingURL=public/src/modules/translator.js.map