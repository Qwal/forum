"use strict";define("chat",["components","taskbar","string","sounds","forum/chats","forum/chats/messages","translator","scrollStop","benchpress"],function(r,s,t,i,d,c,n,l,u){var m={};var f=false;m.prepareDOM=function(){var t=r.get("chat/dropdown");var a=r.get("chat/list");t.on("click",function(){if(t.parent().hasClass("open")){return}m.loadChatsDropdown(a)});a.on("click","[data-roomid]",function(t){if($(t.target).parents(".user-link").length){return}var a=$(this).attr("data-roomid");if(!ajaxify.currentPage.match(/^chats\//)){app.openChat(a)}else{ajaxify.go("user/"+app.user.userslug+"/chats/"+a)}});$('[component="chats/mark-all-read"]').on("click",function(){socket.emit("modules.chats.markAllRead",function(t){if(t){return app.alertError(t)}})});socket.on("event:chats.receive",function(e){var o=e.message.fromUser.username;var n=e.self===1;e.message.self=e.self;f=e.self===0;if(m.modalExists(e.roomId)){var t=m.getModal(e.roomId);c.appendChatMessage(t.find(".chat-content"),e.message);if(t.is(":visible")){s.updateActive(t.attr("UUID"));c.scrollToBottom(t.find(".chat-content"))}else if(!ajaxify.data.template.chats){m.toggleNew(t.attr("UUID"),true,true)}if(!n&&(!t.is(":visible")||!app.isFocused)){app.alternatingTitle("[[modules:chat.user_has_messaged_you, "+o+"]]");i.play("chat-incoming","chat.incoming:"+e.message.mid);s.push("chat",t.attr("UUID"),{title:e.roomName||o,touid:e.message.fromUser.uid,roomId:e.roomId})}}else if(!ajaxify.data.template.chats){socket.emit("modules.chats.loadRoom",{roomId:e.roomId},function(t,a){if(t){return app.alertError(t.message)}a.users=a.users.filter(function(t){return t&&parseInt(t.uid,10)!==parseInt(app.user.uid,10)});a.silent=true;a.uid=app.user.uid;m.createModal(a,function(t){m.toggleNew(t.attr("UUID"),!n,true);if(!n){app.alternatingTitle("[[modules:chat.user_has_messaged_you, "+o+"]]");i.play("chat-incoming","chat.incoming:"+e.message.mid)}})})}});socket.on("event:user_status_change",function(t){var a=m.getModal(t.uid);app.updateUserStatus(a.find('[component="user/status"]'),t.status)});socket.on("event:chats.roomRename",function(t){var a=$("<div/>").html(t.newName).text();var e=m.getModal(t.roomId);e.find('[component="chat/room/name"]').text(a);s.updateTitle("chat",e.attr("UUID"),a)});c.onChatMessageEdit()};m.loadChatsDropdown=function(o){socket.emit("modules.chats.getRecentChats",{uid:app.user.uid,after:0},function(t,a){if(t){return app.alertError(t.message)}var e=a.rooms.filter(function(t){return t.teaser});u.parse("partials/chats/dropdown",{rooms:e},function(t){n.translate(t,function(t){o.empty().html(t);app.createUserTooltips(o,"right")})})})};m.bringModalToTop=function(t){var a=0;s.updateActive(t.attr("UUID"));if($(".chat-modal").length===1){return}$(".chat-modal").each(function(){var t=parseInt($(this).css("zIndex"),10);if(t>a){a=t}});t.css("zIndex",a+1)};m.getModal=function(t){return $("#chat-modal-"+t)};m.modalExists=function(t){return $("#chat-modal-"+t).length!==0};m.createModal=function(n,i){app.parseAndTranslate("chat",n,function(e){var t=utils.generateUUID();var a=false;e.attr("id","chat-modal-"+n.roomId);e.attr("data-roomid",n.roomId);e.attr("intervalId",0);e.attr("UUID",t);e.css("position","fixed");e.css("zIndex",100);e.appendTo($("body"));e.find(".timeago").timeago();m.center(e);app.loadJQueryUI(function(){e.find(".modal-content").resizable({handles:"n, e, s, w, se",minHeight:250,minWidth:400});e.find(".modal-content").on("resize",function(t,a){if(a.originalSize.height===a.size.height){return}e.find(".modal-body").css("height",m.calculateChatListHeight(e))});e.draggable({start:function(){m.bringModalToTop(e)},stop:function(){e.find("#chat-message-input").focus()},distance:10,handle:".modal-header"})});l.apply(e.find('[component="chat/messages"]'));e.find("#chat-close-btn").on("click",function(){m.close(e)});function o(){var t=r.get("chat/input").val();$(window).one("action:ajaxify.end",function(){r.get("chat/input").val(t)});ajaxify.go("user/"+app.user.userslug+"/chats/"+e.attr("data-roomid"));m.close(e)}e.find(".modal-header").on("dblclick",o);e.find('button[data-action="maximize"]').on("click",o);e.find('button[data-action="minimize"]').on("click",function(){var t=e.attr("uuid");m.minimize(t)});e.on("click",function(){m.bringModalToTop(e);if(a){a=false}});e.on("mousemove",function(t){if(t.which===1){a=true}});e.on("mousemove keypress click",function(){if(f){socket.emit("modules.chats.markRead",n.roomId);f=false}});d.addActionHandlers(e.find('[component="chat/messages"]'),n.roomId);d.addRenameHandler(e.attr("data-roomid"),e.find('[data-action="rename"]'),e.attr("data-name"));d.addLeaveHandler(e.attr("data-roomid"),e.find('[data-action="leave"]'));d.addSendHandlers(e.attr("data-roomid"),e.find(".chat-input"),e.find('[data-action="send"]'));d.addMemberHandler(e.attr("data-roomid"),e.find('[data-action="members"]'));d.createAutoComplete(e.find('[component="chat/input"]'));d.addScrollHandler(e.attr("data-roomid"),n.uid,e.find(".chat-content"));d.addCharactersLeftHandler(e);s.push("chat",e.attr("UUID"),{title:n.roomName||(n.users.length?n.users[0].username:""),roomId:n.roomId,icon:"fa-comment",state:""});$(window).trigger("action:chat.loaded",e);if(typeof i==="function"){i(e)}})};m.focusInput=function(t){t.find("#chat-message-input").focus()};m.close=function(t){clearInterval(t.attr("intervalId"));t.attr("intervalId",0);t.remove();t.data("modal",null);s.discard("chat",t.attr("UUID"));if(t.attr("data-mobile")){m.disableMobileBehaviour(t)}};m.center=function(t){var a=false;if(t.hasClass("hide")){t.removeClass("hide");a=true}t.css("left",Math.max(0,($(window).width()-$(t).outerWidth())/2+$(window).scrollLeft())+"px");t.css("top",Math.max(0,$(window).height()/2-$(t).outerHeight()/2)+"px");if(a){t.addClass("hide")}return t};m.load=function(t){var a=$('div[UUID="'+t+'"]');a.removeClass("hide");s.updateActive(t);c.scrollToBottom(a.find(".chat-content"));m.bringModalToTop(a);m.focusInput(a);socket.emit("modules.chats.markRead",a.attr("data-roomid"));var e=utils.findBootstrapEnvironment();if(e==="xs"||e==="sm"){m.enableMobileBehaviour(a)}};m.enableMobileBehaviour=function(t){app.toggleNavbar(false);t.attr("data-mobile","1");var a=t.find(".modal-body");a.css("height",m.calculateChatListHeight(t));$(window).on("resize",function(){a.css("height",m.calculateChatListHeight(t))})};m.disableMobileBehaviour=function(){app.toggleNavbar(true)};m.calculateChatListHeight=function(t){return t.find(".modal-content").outerHeight()-t.find(".modal-header").outerHeight()};m.minimize=function(t){var a=$('div[UUID="'+t+'"]');a.addClass("hide");s.minimize("chat",t);clearInterval(a.attr("intervalId"));a.attr("intervalId",0)};m.toggleNew=s.toggleNew;return m});
//# sourceMappingURL=public/src/modules/chat.js.map