"use strict";define("admin/general/dashboard",["semver","Chart","translator","benchpress"],function(a,u,g,p){var f={};var e={rooms:false,graphs:false};var m=false;var n={rooms:{},traffic:{}};var o={units:"hours",until:undefined};var t={roomInterval:1e4,graphInterval:15e3,realtimeInterval:1500};var s=[];$(window).on("action:ajaxify.start",function(){clearInterval(e.rooms);clearInterval(e.graphs);e.rooms=null;e.graphs=null;n.rooms=null;n.traffic=null;s.length=0});f.init=function(){app.enterRoom("admin");m=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);$('[data-toggle="tooltip"]').tooltip();C();d(function(){socket.emit("admin.rooms.getAll",f.updateRoomUsage);B()})};f.updateRoomUsage=function(a,e){if(a){return app.alertError(a.message)}if(JSON.stringify(n.rooms)===JSON.stringify(e)){return}n.rooms=e;var t='<div class="text-center pull-left">'+'<span class="formatted-number">'+e.onlineRegisteredCount+"</span>"+'<div class="stat">[[admin/general/dashboard:active-users.users]]</div>'+"</div>"+'<div class="text-center pull-left">'+'<span class="formatted-number">'+e.onlineGuestCount+"</span>"+'<div class="stat">[[admin/general/dashboard:active-users.guests]]</div>'+"</div>"+'<div class="text-center pull-left">'+'<span class="formatted-number">'+(e.onlineRegisteredCount+e.onlineGuestCount)+"</span>"+'<div class="stat">[[admin/general/dashboard:active-users.total]]</div>'+"</div>"+'<div class="text-center pull-left">'+'<span class="formatted-number">'+e.socketCount+"</span>"+'<div class="stat">[[admin/general/dashboard:active-users.connections]]</div>'+"</div>";l(e.onlineRegisteredCount,e.onlineGuestCount);c(e.users);y(e.topTenTopics);$("#active-users").translateHtml(t)};var v={traffic:null,registered:null,presence:null,topics:null};var r=["#bf616a","#5B90BF","#d08770","#ebcb8b","#a3be8c","#96b5b4","#8fa1b3","#b48ead","#ab7967","#46BFBD"];function i(a,e){var t=false;if(a[0]==="#"){a=a.slice(1);t=true}var s=parseInt(a,16);var r=(s>>16)+e;if(r>255)r=255;else if(r<0)r=0;var n=(s>>8&255)+e;if(n>255)n=255;else if(n<0)n=0;var o=(s&255)+e;if(o>255)o=255;else if(o<0)o=0;return(t?"#":"")+(o|n<<8|r<<16).toString(16)}function d(t){t=t||function(){};var s=document.getElementById("analytics-traffic");var a=document.getElementById("analytics-registered");var e=document.getElementById("analytics-presence");var r=document.getElementById("analytics-topics");var n=s.getContext("2d");var o=a.getContext("2d");var i=e.getContext("2d");var d=r.getContext("2d");var l=utils.getHoursArray();if(m){u.defaults.global.tooltips.enabled=false}var c=g.Translator.create();Promise.all([c.translateKey("admin/general/dashboard:graphs.page-views",[]),c.translateKey("admin/general/dashboard:graphs.unique-visitors",[]),c.translateKey("admin/general/dashboard:graphs.registered-users",[]),c.translateKey("admin/general/dashboard:graphs.anonymous-users",[]),c.translateKey("admin/general/dashboard:on-categories",[]),c.translateKey("admin/general/dashboard:reading-posts",[]),c.translateKey("admin/general/dashboard:browsing-topics",[]),c.translateKey("admin/general/dashboard:recent",[]),c.translateKey("admin/general/dashboard:unread",[])]).then(function(a){var e={labels:l,datasets:[{label:a[0],backgroundColor:"rgba(220,220,220,0.2)",borderColor:"rgba(220,220,220,1)",pointBackgroundColor:"rgba(220,220,220,1)",pointHoverBackgroundColor:"#fff",pointBorderColor:"#fff",pointHoverBorderColor:"rgba(220,220,220,1)",data:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},{label:a[1],backgroundColor:"rgba(151,187,205,0.2)",borderColor:"rgba(151,187,205,1)",pointBackgroundColor:"rgba(151,187,205,1)",pointHoverBackgroundColor:"rgba(151,187,205,1)",pointBorderColor:"#fff",pointHoverBorderColor:"rgba(151,187,205,1)",data:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}]};s.width=$(s).parent().width();e.datasets[0].yAxisID="left-y-axis";e.datasets[1].yAxisID="right-y-axis";v.traffic=new u(n,{type:"line",data:e,options:{responsive:true,legend:{display:false},scales:{yAxes:[{id:"left-y-axis",ticks:{beginAtZero:true},type:"linear",position:"left",scaleLabel:{display:true,labelString:a[0]}},{id:"right-y-axis",ticks:{beginAtZero:true,suggestedMax:10},type:"linear",position:"right",scaleLabel:{display:true,labelString:a[1]}}]},tooltips:{mode:"x"}}});v.registered=new u(o,{type:"doughnut",data:{labels:a.slice(2,4),datasets:[{data:[1,1],backgroundColor:["#F7464A","#46BFBD"],hoverBackgroundColor:["#FF5A5E","#5AD3D1"]}]},options:{responsive:true,legend:{display:false}}});v.presence=new u(i,{type:"doughnut",data:{labels:a.slice(4,9),datasets:[{data:[1,1,1,1,1],backgroundColor:["#F7464A","#46BFBD","#FDB45C","#949FB1","#9FB194"],hoverBackgroundColor:["#FF5A5E","#5AD3D1","#FFC870","#A8B3C5","#A8B3C5"]}]},options:{responsive:true,legend:{display:false}}});v.topics=new u(d,{type:"doughnut",data:{labels:[],datasets:[{data:[],backgroundColor:[],hoverBackgroundColor:[]}]},options:{responsive:true,legend:{display:false}}});h();$(window).on("resize",b);b();$('[data-action="updateGraph"]:not([data-units="custom"])').on("click",function(){var a=new Date;var e=$(this).attr("data-amount");if($(this).attr("data-units")==="days"){a.setHours(0,0,0,0)}a=a.getTime();h($(this).attr("data-units"),a,e);$('[data-action="updateGraph"]').removeClass("active");$(this).addClass("active");require(["translator"],function(a){a.translate("[[admin/general/dashboard:page-views-custom]]",function(a){$('[data-action="updateGraph"][data-units="custom"]').text(a)})})});$('[data-action="updateGraph"][data-units="custom"]').on("click",function(){var n=$(this);p.parse("admin/partials/pageviews-range-select",{},function(a){var r=bootbox.dialog({title:"[[admin/general/dashboard:page-views-custom]]",message:a,buttons:{submit:{label:"[[global:search]]",className:"btn-primary",callback:e}}});function e(){var a=r.find("form").serializeObject();var e=/\d{4}-\d{2}-\d{2}/;if(!a.startRange&&!a.endRange){h("days");$('[data-action="updateGraph"]').removeClass("active");$('[data-action="updateGraph"][data-units="days"]').addClass("active");return}else if(!e.test(a.startRange)||!e.test(a.endRange)){r.find(".alert-danger").removeClass("hidden");return false}var t=new Date(a.endRange);t.setDate(t.getDate()+1);t=t.getTime();var s=(t-new Date(a.startRange).getTime())/(1e3*60*60*24);h("days",t,s);$('[data-action="updateGraph"]').removeClass("active");n.addClass("active");n.html(a.startRange+" &ndash; "+a.endRange)}})});socket.emit("admin.rooms.getAll",f.updateRoomUsage);B();t()})}function b(){$(".pie-chart.legend-up").each(function(){var a=$(this);if(a.width()<320){a.addClass("compact")}else{a.removeClass("compact")}})}function h(t,s,r){if(!app.isFocused){return}socket.emit("admin.analytics.get",{graph:"traffic",units:t||"hours",until:s,amount:r},function(a,e){if(a){return app.alertError(a.message)}if(JSON.stringify(n.traffic)===JSON.stringify(e)){return}n.traffic=e;if(t==="days"){v.traffic.data.xLabels=utils.getDaysArray(s,r)}else{v.traffic.data.xLabels=utils.getHoursArray();$("#pageViewsThirty").html(e.summary.thirty);$("#pageViewsSeven").html(e.summary.seven);$("#pageViewsPastDay").html(e.pastDay);utils.addCommasToNumbers($("#pageViewsThirty"));utils.addCommasToNumbers($("#pageViewsSeven"));utils.addCommasToNumbers($("#pageViewsPastDay"))}v.traffic.data.datasets[0].data=e.pageviews;v.traffic.data.datasets[1].data=e.uniqueVisitors;v.traffic.data.labels=v.traffic.data.xLabels;v.traffic.update();o.units=t;o.until=s;o.amount=r})}function l(a,e){v.registered.data.datasets[0].data[0]=a;v.registered.data.datasets[0].data[1]=e;v.registered.update()}function c(a){v.presence.data.datasets[0].data[0]=a.categories;v.presence.data.datasets[0].data[1]=a.topics;v.presence.data.datasets[0].data[2]=a.category;v.presence.data.datasets[0].data[3]=a.recent;v.presence.data.datasets[0].data[4]=a.unread;v.presence.update()}function y(a){if(!a.length){a=[{title:"No users browsing",count:1}]}v.topics.data.labels=[];v.topics.data.datasets[0].data=[];v.topics.data.datasets[0].backgroundColor=[];v.topics.data.datasets[0].hoverBackgroundColor=[];a.forEach(function(a,e){v.topics.data.labels.push(a.title);v.topics.data.datasets[0].data.push(a.count);v.topics.data.datasets[0].backgroundColor.push(r[e]);v.topics.data.datasets[0].hoverBackgroundColor.push(i(r[e],10))});function e(){var s=$("#topics-legend").html("");a.forEach(function(a,e){var t=a.count==="0"?a.title:'<a title="'+a.title+'"href="'+RELATIVE_PATH+"/topic/"+a.tid+'" target="_blank"> '+a.title+"</a>";s.append("<li>"+'<div style="background-color: '+r[e]+';"></div>'+"<span>"+t+"</span>"+"</li>")})}e();v.topics.update()}function C(){$("#toggle-realtime .fa").on("click",function(){var a=$(this);if(a.hasClass("fa-toggle-on")){a.removeClass("fa-toggle-on").addClass("fa-toggle-off");a.parent().find("strong").html("OFF");B(false)}else{a.removeClass("fa-toggle-off").addClass("fa-toggle-on");a.parent().find("strong").html("ON");B(true)}})}function B(a){clearInterval(e.rooms);clearInterval(e.graphs);e.rooms=setInterval(function(){if(app.isFocused&&app.isConnected){socket.emit("admin.rooms.getAll",f.updateRoomUsage)}},a?t.realtimeInterval:t.roomInterval);e.graphs=setInterval(function(){h(o.units,o.until,o.amount)},a?t.realtimeInterval:t.graphInterval)}return f});
//# sourceMappingURL=public/src/admin/general/dashboard.js.map