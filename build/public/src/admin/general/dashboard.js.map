{"version":3,"sources":["public/src/admin/general/dashboard.js"],"names":["define","semver","Chart","translator","Benchpress","Admin","intervals","rooms","graphs","isMobile","graphData","traffic","currentGraph","units","until","undefined","DEFAULTS","roomInterval","graphInterval","realtimeInterval","usedTopicColors","$","window","on","clearInterval","length","init","app","enterRoom","test","navigator","userAgent","tooltip","setupRealtimeButton","setupGraphs","socket","emit","updateRoomUsage","initiateDashboard","err","data","alertError","message","JSON","stringify","html","onlineRegisteredCount","onlineGuestCount","socketCount","updateRegisteredGraph","updatePresenceGraph","users","updateTopicsGraph","topTenTopics","translateHtml","registered","presence","topics","topicColors","lighten","col","amt","usePound","slice","num","parseInt","r","b","g","toString","callback","trafficCanvas","document","getElementById","registeredCanvas","presenceCanvas","topicsCanvas","trafficCtx","getContext","registeredCtx","presenceCtx","topicsCtx","trafficLabels","utils","getHoursArray","defaults","global","tooltips","enabled","t","Translator","create","Promise","all","translateKey","then","translations","labels","datasets","label","backgroundColor","borderColor","pointBackgroundColor","pointHoverBackgroundColor","pointBorderColor","pointHoverBorderColor","width","parent","yAxisID","type","options","responsive","legend","display","scales","yAxes","id","ticks","beginAtZero","position","scaleLabel","labelString","suggestedMax","mode","hoverBackgroundColor","updateTrafficGraph","adjustPieCharts","Date","amount","this","attr","setHours","getTime","removeClass","addClass","require","translate","translated","text","targetEl","parse","modal","bootbox","dialog","title","buttons","submit","className","formData","find","serializeObject","validRegexp","startRange","endRange","setDate","getDate","each","$this","isFocused","graph","xLabels","getDaysArray","summary","thirty","seven","pastDay","addCommasToNumbers","pageviews","uniqueVisitors","update","anonymous","categories","category","recent","unread","count","forEach","topic","i","push","buildTopicsLegend","RELATIVE_PATH","tid","append","hasClass","realtime","setInterval","isConnected"],"mappings":"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","file":"public/src/admin/general/dashboard.js","sourcesContent":["'use strict';\n\n\ndefine('admin/general/dashboard', ['semver', 'Chart', 'translator', 'benchpress'], function (semver, Chart, translator, Benchpress) {\n\tvar\tAdmin = {};\n\tvar\tintervals = {\n\t\trooms: false,\n\t\tgraphs: false,\n\t};\n\tvar\tisMobile = false;\n\tvar\tgraphData = {\n\t\trooms: {},\n\t\ttraffic: {},\n\t};\n\tvar\tcurrentGraph = {\n\t\tunits: 'hours',\n\t\tuntil: undefined,\n\t};\n\n\tvar DEFAULTS = {\n\t\troomInterval: 10000,\n\t\tgraphInterval: 15000,\n\t\trealtimeInterval: 1500,\n\t};\n\n\tvar\tusedTopicColors = [];\n\n\t$(window).on('action:ajaxify.start', function () {\n\t\tclearInterval(intervals.rooms);\n\t\tclearInterval(intervals.graphs);\n\n\t\tintervals.rooms = null;\n\t\tintervals.graphs = null;\n\t\tgraphData.rooms = null;\n\t\tgraphData.traffic = null;\n\t\tusedTopicColors.length = 0;\n\t});\n\n\tAdmin.init = function () {\n\t\tapp.enterRoom('admin');\n\n\t\tisMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);\n\n\t\t$('[data-toggle=\"tooltip\"]').tooltip();\n\n\t\tsetupRealtimeButton();\n\t\tsetupGraphs(function () {\n\t\t\tsocket.emit('admin.rooms.getAll', Admin.updateRoomUsage);\n\t\t\tinitiateDashboard();\n\t\t});\n\t};\n\n\tAdmin.updateRoomUsage = function (err, data) {\n\t\tif (err) {\n\t\t\treturn app.alertError(err.message);\n\t\t}\n\n\t\tif (JSON.stringify(graphData.rooms) === JSON.stringify(data)) {\n\t\t\treturn;\n\t\t}\n\n\t\tgraphData.rooms = data;\n\n\t\tvar html = '<div class=\"text-center pull-left\">' +\n\t\t\t\t\t\t'<span class=\"formatted-number\">' + data.onlineRegisteredCount + '</span>' +\n\t\t\t\t\t\t'<div class=\"stat\">[[admin/general/dashboard:active-users.users]]</div>' +\n\t\t\t\t\t'</div>' +\n\t\t\t\t\t'<div class=\"text-center pull-left\">' +\n\t\t\t\t\t\t'<span class=\"formatted-number\">' + data.onlineGuestCount + '</span>' +\n\t\t\t\t\t\t'<div class=\"stat\">[[admin/general/dashboard:active-users.guests]]</div>' +\n\t\t\t\t\t'</div>' +\n\t\t\t\t\t'<div class=\"text-center pull-left\">' +\n\t\t\t\t\t\t'<span class=\"formatted-number\">' + (data.onlineRegisteredCount + data.onlineGuestCount) + '</span>' +\n\t\t\t\t\t\t'<div class=\"stat\">[[admin/general/dashboard:active-users.total]]</div>' +\n\t\t\t\t\t'</div>' +\n\t\t\t\t\t'<div class=\"text-center pull-left\">' +\n\t\t\t\t\t\t'<span class=\"formatted-number\">' + data.socketCount + '</span>' +\n\t\t\t\t\t\t'<div class=\"stat\">[[admin/general/dashboard:active-users.connections]]</div>' +\n\t\t\t\t\t'</div>';\n\n\t\tupdateRegisteredGraph(data.onlineRegisteredCount, data.onlineGuestCount);\n\t\tupdatePresenceGraph(data.users);\n\t\tupdateTopicsGraph(data.topTenTopics);\n\n\t\t$('#active-users').translateHtml(html);\n\t};\n\n\tvar graphs = {\n\t\ttraffic: null,\n\t\tregistered: null,\n\t\tpresence: null,\n\t\ttopics: null,\n\t};\n\n\tvar topicColors = ['#bf616a', '#5B90BF', '#d08770', '#ebcb8b', '#a3be8c', '#96b5b4', '#8fa1b3', '#b48ead', '#ab7967', '#46BFBD'];\n\n\t/* eslint-disable */\n\t// from chartjs.org\n\tfunction lighten(col, amt) {\n\t\tvar usePound = false;\n\n\t\tif (col[0] === '#') {\n\t\t\tcol = col.slice(1);\n\t\t\tusePound = true;\n\t\t}\n\n\t\tvar num = parseInt(col, 16);\n\n\t\tvar r = (num >> 16) + amt;\n\n\t\tif (r > 255) r = 255;\n\t\telse if (r < 0) r = 0;\n\n\t\tvar b = ((num >> 8) & 0x00FF) + amt;\n\n\t\tif (b > 255) b = 255;\n\t\telse if (b < 0) b = 0;\n\n\t\tvar g = (num & 0x0000FF) + amt;\n\n\t\tif (g > 255) g = 255;\n\t\telse if (g < 0) g = 0;\n\n\t\treturn (usePound ? '#' : '') + (g | (b << 8) | (r << 16)).toString(16);\n\t}\n\t/* eslint-enable */\n\n\tfunction setupGraphs(callback) {\n\t\tcallback = callback || function () {};\n\t\tvar trafficCanvas = document.getElementById('analytics-traffic');\n\t\tvar registeredCanvas = document.getElementById('analytics-registered');\n\t\tvar presenceCanvas = document.getElementById('analytics-presence');\n\t\tvar topicsCanvas = document.getElementById('analytics-topics');\n\t\tvar trafficCtx = trafficCanvas.getContext('2d');\n\t\tvar registeredCtx = registeredCanvas.getContext('2d');\n\t\tvar presenceCtx = presenceCanvas.getContext('2d');\n\t\tvar topicsCtx = topicsCanvas.getContext('2d');\n\t\tvar trafficLabels = utils.getHoursArray();\n\n\t\tif (isMobile) {\n\t\t\tChart.defaults.global.tooltips.enabled = false;\n\t\t}\n\n\t\tvar t = translator.Translator.create();\n\t\tPromise.all([\n\t\t\tt.translateKey('admin/general/dashboard:graphs.page-views', []),\n\t\t\tt.translateKey('admin/general/dashboard:graphs.unique-visitors', []),\n\t\t\tt.translateKey('admin/general/dashboard:graphs.registered-users', []),\n\t\t\tt.translateKey('admin/general/dashboard:graphs.anonymous-users', []),\n\t\t\tt.translateKey('admin/general/dashboard:on-categories', []),\n\t\t\tt.translateKey('admin/general/dashboard:reading-posts', []),\n\t\t\tt.translateKey('admin/general/dashboard:browsing-topics', []),\n\t\t\tt.translateKey('admin/general/dashboard:recent', []),\n\t\t\tt.translateKey('admin/general/dashboard:unread', []),\n\t\t]).then(function (translations) {\n\t\t\tvar data = {\n\t\t\t\tlabels: trafficLabels,\n\t\t\t\tdatasets: [\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: translations[0],\n\t\t\t\t\t\tbackgroundColor: 'rgba(220,220,220,0.2)',\n\t\t\t\t\t\tborderColor: 'rgba(220,220,220,1)',\n\t\t\t\t\t\tpointBackgroundColor: 'rgba(220,220,220,1)',\n\t\t\t\t\t\tpointHoverBackgroundColor: '#fff',\n\t\t\t\t\t\tpointBorderColor: '#fff',\n\t\t\t\t\t\tpointHoverBorderColor: 'rgba(220,220,220,1)',\n\t\t\t\t\t\tdata: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: translations[1],\n\t\t\t\t\t\tbackgroundColor: 'rgba(151,187,205,0.2)',\n\t\t\t\t\t\tborderColor: 'rgba(151,187,205,1)',\n\t\t\t\t\t\tpointBackgroundColor: 'rgba(151,187,205,1)',\n\t\t\t\t\t\tpointHoverBackgroundColor: 'rgba(151,187,205,1)',\n\t\t\t\t\t\tpointBorderColor: '#fff',\n\t\t\t\t\t\tpointHoverBorderColor: 'rgba(151,187,205,1)',\n\t\t\t\t\t\tdata: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t};\n\n\t\t\ttrafficCanvas.width = $(trafficCanvas).parent().width();\n\n\t\t\tdata.datasets[0].yAxisID = 'left-y-axis';\n\t\t\tdata.datasets[1].yAxisID = 'right-y-axis';\n\n\t\t\tgraphs.traffic = new Chart(trafficCtx, {\n\t\t\t\ttype: 'line',\n\t\t\t\tdata: data,\n\t\t\t\toptions: {\n\t\t\t\t\tresponsive: true,\n\t\t\t\t\tlegend: {\n\t\t\t\t\t\tdisplay: false,\n\t\t\t\t\t},\n\t\t\t\t\tscales: {\n\t\t\t\t\t\tyAxes: [{\n\t\t\t\t\t\t\tid: 'left-y-axis',\n\t\t\t\t\t\t\tticks: {\n\t\t\t\t\t\t\t\tbeginAtZero: true,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\ttype: 'linear',\n\t\t\t\t\t\t\tposition: 'left',\n\t\t\t\t\t\t\tscaleLabel: {\n\t\t\t\t\t\t\t\tdisplay: true,\n\t\t\t\t\t\t\t\tlabelString: translations[0],\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t}, {\n\t\t\t\t\t\t\tid: 'right-y-axis',\n\t\t\t\t\t\t\tticks: {\n\t\t\t\t\t\t\t\tbeginAtZero: true,\n\t\t\t\t\t\t\t\tsuggestedMax: 10,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\ttype: 'linear',\n\t\t\t\t\t\t\tposition: 'right',\n\t\t\t\t\t\t\tscaleLabel: {\n\t\t\t\t\t\t\t\tdisplay: true,\n\t\t\t\t\t\t\t\tlabelString: translations[1],\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t}],\n\t\t\t\t\t},\n\t\t\t\t\ttooltips: {\n\t\t\t\t\t\tmode: 'x',\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tgraphs.registered = new Chart(registeredCtx, {\n\t\t\t\ttype: 'doughnut',\n\t\t\t\tdata: {\n\t\t\t\t\tlabels: translations.slice(2, 4),\n\t\t\t\t\tdatasets: [{\n\t\t\t\t\t\tdata: [1, 1],\n\t\t\t\t\t\tbackgroundColor: ['#F7464A', '#46BFBD'],\n\t\t\t\t\t\thoverBackgroundColor: ['#FF5A5E', '#5AD3D1'],\n\t\t\t\t\t}],\n\t\t\t\t},\n\t\t\t\toptions: {\n\t\t\t\t\tresponsive: true,\n\t\t\t\t\tlegend: {\n\t\t\t\t\t\tdisplay: false,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tgraphs.presence = new Chart(presenceCtx, {\n\t\t\t\ttype: 'doughnut',\n\t\t\t\tdata: {\n\t\t\t\t\tlabels: translations.slice(4, 9),\n\t\t\t\t\tdatasets: [{\n\t\t\t\t\t\tdata: [1, 1, 1, 1, 1],\n\t\t\t\t\t\tbackgroundColor: ['#F7464A', '#46BFBD', '#FDB45C', '#949FB1', '#9FB194'],\n\t\t\t\t\t\thoverBackgroundColor: ['#FF5A5E', '#5AD3D1', '#FFC870', '#A8B3C5', '#A8B3C5'],\n\t\t\t\t\t}],\n\t\t\t\t},\n\t\t\t\toptions: {\n\t\t\t\t\tresponsive: true,\n\t\t\t\t\tlegend: {\n\t\t\t\t\t\tdisplay: false,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tgraphs.topics = new Chart(topicsCtx, {\n\t\t\t\ttype: 'doughnut',\n\t\t\t\tdata: {\n\t\t\t\t\tlabels: [],\n\t\t\t\t\tdatasets: [{\n\t\t\t\t\t\tdata: [],\n\t\t\t\t\t\tbackgroundColor: [],\n\t\t\t\t\t\thoverBackgroundColor: [],\n\t\t\t\t\t}],\n\t\t\t\t},\n\t\t\t\toptions: {\n\t\t\t\t\tresponsive: true,\n\t\t\t\t\tlegend: {\n\t\t\t\t\t\tdisplay: false,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tupdateTrafficGraph();\n\n\t\t\t$(window).on('resize', adjustPieCharts);\n\t\t\tadjustPieCharts();\n\n\t\t\t$('[data-action=\"updateGraph\"]:not([data-units=\"custom\"])').on('click', function () {\n\t\t\t\tvar until = new Date();\n\t\t\t\tvar amount = $(this).attr('data-amount');\n\t\t\t\tif ($(this).attr('data-units') === 'days') {\n\t\t\t\t\tuntil.setHours(0, 0, 0, 0);\n\t\t\t\t}\n\t\t\t\tuntil = until.getTime();\n\t\t\t\tupdateTrafficGraph($(this).attr('data-units'), until, amount);\n\t\t\t\t$('[data-action=\"updateGraph\"]').removeClass('active');\n\t\t\t\t$(this).addClass('active');\n\n\t\t\t\trequire(['translator'], function (translator) {\n\t\t\t\t\ttranslator.translate('[[admin/general/dashboard:page-views-custom]]', function (translated) {\n\t\t\t\t\t\t$('[data-action=\"updateGraph\"][data-units=\"custom\"]').text(translated);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t\t$('[data-action=\"updateGraph\"][data-units=\"custom\"]').on('click', function () {\n\t\t\t\tvar targetEl = $(this);\n\n\t\t\t\tBenchpress.parse('admin/partials/pageviews-range-select', {}, function (html) {\n\t\t\t\t\tvar modal = bootbox.dialog({\n\t\t\t\t\t\ttitle: '[[admin/general/dashboard:page-views-custom]]',\n\t\t\t\t\t\tmessage: html,\n\t\t\t\t\t\tbuttons: {\n\t\t\t\t\t\t\tsubmit: {\n\t\t\t\t\t\t\t\tlabel: '[[global:search]]',\n\t\t\t\t\t\t\t\tclassName: 'btn-primary',\n\t\t\t\t\t\t\t\tcallback: submit,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\n\t\t\t\t\tfunction submit() {\n\t\t\t\t\t\t// NEED TO ADD VALIDATION HERE FOR YYYY-MM-DD\n\t\t\t\t\t\tvar formData = modal.find('form').serializeObject();\n\t\t\t\t\t\tvar validRegexp = /\\d{4}-\\d{2}-\\d{2}/;\n\n\t\t\t\t\t\t// Input validation\n\t\t\t\t\t\tif (!formData.startRange && !formData.endRange) {\n\t\t\t\t\t\t\t// No range? Assume last 30 days\n\t\t\t\t\t\t\tupdateTrafficGraph('days');\n\t\t\t\t\t\t\t$('[data-action=\"updateGraph\"]').removeClass('active');\n\t\t\t\t\t\t\t$('[data-action=\"updateGraph\"][data-units=\"days\"]').addClass('active');\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t} else if (!validRegexp.test(formData.startRange) || !validRegexp.test(formData.endRange)) {\n\t\t\t\t\t\t\t// Invalid Input\n\t\t\t\t\t\t\tmodal.find('.alert-danger').removeClass('hidden');\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvar until = new Date(formData.endRange);\n\t\t\t\t\t\tuntil.setDate(until.getDate() + 1);\n\t\t\t\t\t\tuntil = until.getTime();\n\t\t\t\t\t\tvar amount = (until - new Date(formData.startRange).getTime()) / (1000 * 60 * 60 * 24);\n\n\t\t\t\t\t\tupdateTrafficGraph('days', until, amount);\n\t\t\t\t\t\t$('[data-action=\"updateGraph\"]').removeClass('active');\n\t\t\t\t\t\ttargetEl.addClass('active');\n\n\t\t\t\t\t\t// Update \"custom range\" label\n\t\t\t\t\t\ttargetEl.html(formData.startRange + ' &ndash; ' + formData.endRange);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tsocket.emit('admin.rooms.getAll', Admin.updateRoomUsage);\n\t\t\tinitiateDashboard();\n\t\t\tcallback();\n\t\t});\n\t}\n\n\tfunction adjustPieCharts() {\n\t\t$('.pie-chart.legend-up').each(function () {\n\t\t\tvar $this = $(this);\n\n\t\t\tif ($this.width() < 320) {\n\t\t\t\t$this.addClass('compact');\n\t\t\t} else {\n\t\t\t\t$this.removeClass('compact');\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction updateTrafficGraph(units, until, amount) {\n\t\t// until and amount are optional\n\n\t\tif (!app.isFocused) {\n\t\t\treturn;\n\t\t}\n\n\t\tsocket.emit('admin.analytics.get', {\n\t\t\tgraph: 'traffic',\n\t\t\tunits: units || 'hours',\n\t\t\tuntil: until,\n\t\t\tamount: amount,\n\t\t}, function (err, data) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\t\t\tif (JSON.stringify(graphData.traffic) === JSON.stringify(data)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tgraphData.traffic = data;\n\n\t\t\tif (units === 'days') {\n\t\t\t\tgraphs.traffic.data.xLabels = utils.getDaysArray(until, amount);\n\t\t\t} else {\n\t\t\t\tgraphs.traffic.data.xLabels = utils.getHoursArray();\n\n\t\t\t\t$('#pageViewsThirty').html(data.summary.thirty);\n\t\t\t\t$('#pageViewsSeven').html(data.summary.seven);\n\t\t\t\t$('#pageViewsPastDay').html(data.pastDay);\n\t\t\t\tutils.addCommasToNumbers($('#pageViewsThirty'));\n\t\t\t\tutils.addCommasToNumbers($('#pageViewsSeven'));\n\t\t\t\tutils.addCommasToNumbers($('#pageViewsPastDay'));\n\t\t\t}\n\n\t\t\tgraphs.traffic.data.datasets[0].data = data.pageviews;\n\t\t\tgraphs.traffic.data.datasets[1].data = data.uniqueVisitors;\n\t\t\tgraphs.traffic.data.labels = graphs.traffic.data.xLabels;\n\n\t\t\tgraphs.traffic.update();\n\t\t\tcurrentGraph.units = units;\n\t\t\tcurrentGraph.until = until;\n\t\t\tcurrentGraph.amount = amount;\n\t\t});\n\t}\n\n\tfunction updateRegisteredGraph(registered, anonymous) {\n\t\tgraphs.registered.data.datasets[0].data[0] = registered;\n\t\tgraphs.registered.data.datasets[0].data[1] = anonymous;\n\t\tgraphs.registered.update();\n\t}\n\n\tfunction updatePresenceGraph(users) {\n\t\tgraphs.presence.data.datasets[0].data[0] = users.categories;\n\t\tgraphs.presence.data.datasets[0].data[1] = users.topics;\n\t\tgraphs.presence.data.datasets[0].data[2] = users.category;\n\t\tgraphs.presence.data.datasets[0].data[3] = users.recent;\n\t\tgraphs.presence.data.datasets[0].data[4] = users.unread;\n\n\t\tgraphs.presence.update();\n\t}\n\n\tfunction updateTopicsGraph(topics) {\n\t\tif (!topics.length) {\n\t\t\ttopics = [{\n\t\t\t\ttitle: 'No users browsing',\n\t\t\t\tcount: 1,\n\t\t\t}];\n\t\t}\n\n\t\tgraphs.topics.data.labels = [];\n\t\tgraphs.topics.data.datasets[0].data = [];\n\t\tgraphs.topics.data.datasets[0].backgroundColor = [];\n\t\tgraphs.topics.data.datasets[0].hoverBackgroundColor = [];\n\n\t\ttopics.forEach(function (topic, i) {\n\t\t\tgraphs.topics.data.labels.push(topic.title);\n\t\t\tgraphs.topics.data.datasets[0].data.push(topic.count);\n\t\t\tgraphs.topics.data.datasets[0].backgroundColor.push(topicColors[i]);\n\t\t\tgraphs.topics.data.datasets[0].hoverBackgroundColor.push(lighten(topicColors[i], 10));\n\t\t});\n\n\t\tfunction buildTopicsLegend() {\n\t\t\tvar legend = $('#topics-legend').html('');\n\n\t\t\ttopics.forEach(function (topic, i) {\n\t\t\t\tvar\tlabel = topic.count === '0' ? topic.title : '<a title=\"' + topic.title + '\"href=\"' + RELATIVE_PATH + '/topic/' + topic.tid + '\" target=\"_blank\"> ' + topic.title + '</a>';\n\n\t\t\t\tlegend.append('<li>' +\n\t\t\t\t\t'<div style=\"background-color: ' + topicColors[i] + ';\"></div>' +\n\t\t\t\t\t'<span>' + label + '</span>' +\n\t\t\t\t\t'</li>');\n\t\t\t});\n\t\t}\n\n\t\tbuildTopicsLegend();\n\t\tgraphs.topics.update();\n\t}\n\n\tfunction setupRealtimeButton() {\n\t\t$('#toggle-realtime .fa').on('click', function () {\n\t\t\tvar $this = $(this);\n\t\t\tif ($this.hasClass('fa-toggle-on')) {\n\t\t\t\t$this.removeClass('fa-toggle-on').addClass('fa-toggle-off');\n\t\t\t\t$this.parent().find('strong').html('OFF');\n\t\t\t\tinitiateDashboard(false);\n\t\t\t} else {\n\t\t\t\t$this.removeClass('fa-toggle-off').addClass('fa-toggle-on');\n\t\t\t\t$this.parent().find('strong').html('ON');\n\t\t\t\tinitiateDashboard(true);\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction initiateDashboard(realtime) {\n\t\tclearInterval(intervals.rooms);\n\t\tclearInterval(intervals.graphs);\n\n\t\tintervals.rooms = setInterval(function () {\n\t\t\tif (app.isFocused && app.isConnected) {\n\t\t\t\tsocket.emit('admin.rooms.getAll', Admin.updateRoomUsage);\n\t\t\t}\n\t\t}, realtime ? DEFAULTS.realtimeInterval : DEFAULTS.roomInterval);\n\n\t\tintervals.graphs = setInterval(function () {\n\t\t\tupdateTrafficGraph(currentGraph.units, currentGraph.until, currentGraph.amount);\n\t\t}, realtime ? DEFAULTS.realtimeInterval : DEFAULTS.graphInterval);\n\t}\n\n\treturn Admin;\n});\n"]}