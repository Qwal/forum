"use strict";define("admin/extend/plugins",["jqueryui","translator","benchpress"],function(e,s,r){var a={};a.init=function(){var t=$(".plugins");var e=t[0].querySelectorAll("li").length;var l;if(!e){s.translate("<li><p><i>[[admin/extend/plugins:none-found]]</i></p></li>",function(e){t.append(e)});return}$("#plugin-search").val("");t.on("click",'button[data-action="toggleActive"]',function(){var i=$(this).parents("li");l=i.attr("data-plugin-id");var n=$("#"+l+' [data-action="toggleActive"]');var a=ajaxify.data.installed[i.attr("data-plugin-index")];function t(){socket.emit("admin.plugins.toggleActive",l,function(e,t){if(e){return app.alertError(e)}s.translate('<i class="fa fa-power-off"></i> [[admin/extend/plugins:plugin-item.'+(t.active?"deactivate":"activate")+"]]",function(e){n.html(e);n.toggleClass("btn-warning",t.active).toggleClass("btn-success",!t.active);if(t.active&&!$("#active #"+l).length){$("#active ul").prepend(i.clone(true))}a.active=!a.active;app.alert({alert_id:"plugin_toggled",title:"[[admin/extend/plugins:alert."+(t.active?"enabled":"disabled")+"]]",message:"[[admin/extend/plugins:alert."+(t.active?"activate-success":"deactivate-success")+"]]",type:t.active?"warning":"success",timeout:5e3,clickfn:function(){require(["admin/modules/instance"],function(e){e.restart()})}})})})}if(a.license&&a.active!==true){r.parse("admin/partials/plugins/license",a,function(e){bootbox.dialog({title:"[[admin/extend/plugins:license.title]]",message:e,size:"large",buttons:{cancel:{label:"[[modules:bootbox.cancel]]",className:"btn-link"},save:{label:"[[modules:bootbox.confirm]]",className:"btn-primary",callback:t}}})})}else{t(l)}});t.on("click",'button[data-action="toggleInstall"]',function(){var i=$(this);i.attr("disabled",true);l=$(this).parents("li").attr("data-plugin-id");if($(this).attr("data-installed")==="1"){return a.toggleInstall(l,$(this).parents("li").attr("data-version"))}a.suggest(l,function(e,t){if(e){bootbox.confirm(s.compile("admin/extend/plugins:alert.suggest-error",e.status,e.responseText),function(e){if(e){a.toggleInstall(l,"latest")}else{i.removeAttr("disabled")}});return}if(t.version!=="latest"){a.toggleInstall(l,t.version)}else if(t.version==="latest"){o(l,function(e){if(e){a.toggleInstall(l,"latest")}else{i.removeAttr("disabled")}})}else{i.removeAttr("disabled")}})});t.on("click",'button[data-action="upgrade"]',function(){var i=$(this);var n=i.parents("li");l=n.attr("data-plugin-id");a.suggest(l,function(e,t){if(e){return bootbox.alert("[[admin/extend/plugins:alert.package-manager-unreachable]]")}require(["semver"],function(e){if(t.version!=="latest"&&e.gt(t.version,n.find(".currentVersion").text())){c(l,i,t.version)}else if(t.version==="latest"){o(l,function(){c(l,i,t.version)})}else{bootbox.alert(s.compile("admin/extend/plugins:alert.incompatible",app.config.version,t.version))}})})});$("#plugin-search").on("input propertychange",function(){var t=$(this).val();$(".plugins li").each(function(){var e=$(this).attr("data-plugin-id");$(this).toggleClass("hide",e&&e.indexOf(t)===-1)})});$("#plugin-order").on("click",function(){$("#order-active-plugins-modal").modal("show");socket.emit("admin.plugins.getActive",function(e,t){if(e){return app.alertError(e)}var i="";t.forEach(function(e){i+='<li class="">'+e+"</li>"});if(!t.length){s.translate("[[admin/extend/plugins:none-active]]",function(e){$("#order-active-plugins-modal .plugin-list").html(e).sortable()});return}$("#order-active-plugins-modal .plugin-list").html(i).sortable()})});$("#save-plugin-order").on("click",function(){var e=$("#order-active-plugins-modal .plugin-list").children();var i=[];e.each(function(e,t){i.push({name:$(t).text(),order:e})});socket.emit("admin.plugins.orderActivePlugins",i,function(e){if(e){return app.alertError(e.message)}$("#order-active-plugins-modal").modal("hide")})});i();n()};function o(e,t){bootbox.confirm(s.compile("admin/extend/plugins:alert.possibly-incompatible",e),function(e){t(e)})}function c(e,n,a){n.attr("disabled",true).find("i").attr("class","fa fa-refresh fa-spin");socket.emit("admin.plugins.upgrade",{id:e,version:a},function(e,t){if(e){return app.alertError(e.message)}var i=n.parents("li");i.find(".fa-exclamation-triangle").remove();i.find(".currentVersion").text(a);n.remove();if(t){app.alert({alert_id:"plugin_upgraded",title:"[[admin/extend/plugins:alert.upgraded]]",message:"[[admin/extend/plugins:alert.upgrade-success]]",type:"warning",timeout:5e3,clickfn:function(){require(["admin/modules/instance"],function(e){e.reload()})}})}})}a.toggleInstall=function(e,t,i){var n=$('li[data-plugin-id="'+e+'"] button[data-action="toggleInstall"]');n.find("i").attr("class","fa fa-refresh fa-spin");socket.emit("admin.plugins.toggleInstall",{id:e,version:t},function(e,t){if(e){n.removeAttr("disabled");return app.alertError(e.message)}ajaxify.refresh();app.alert({alert_id:"plugin_toggled",title:"[[admin/extend/plugins:alert."+(t.installed?"installed":"uninstalled")+"]]",message:"[[admin/extend/plugins:alert."+(t.installed?"install-success":"uninstall-success")+"]]",type:"info",timeout:5e3});if(typeof i==="function"){i.apply(this,arguments)}})};a.suggest=function(e,t){var i=app.config.version.match(/^\d\.\d\.\d/);$.ajax((app.config.registry||"https://packages.nodebb.org")+"/api/v1/suggest",{type:"GET",data:{package:e,version:i[0]},dataType:"json"}).done(function(e){t(undefined,e)}).fail(t)};function i(){$("#installed ul li").each(function(){if($(this).children('[data-action="upgrade"]').length){$("#upgrade ul").append($(this).clone(true))}})}function n(){$("#installed ul li").each(function(){if($(this).hasClass("active")){$("#active ul").append($(this).clone(true))}else{$("#deactive ul").append($(this).clone(true))}})}return a});
//# sourceMappingURL=public/src/admin/extend/plugins.js.map